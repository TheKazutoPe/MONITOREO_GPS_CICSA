<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
// Configurar mapa base
const map = L.map('map').setView([-12.0464, -77.0428], 11);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19,
  attribution: '&copy; OpenStreetMap'
}).addTo(map);

// -------- VARIABLES PRINCIPALES --------
const markers = new Map();
const trails = new Map();
const startPoints = new Map();
const lastSeen = new Map();

const carIcon = L.icon({
  iconUrl: 'https://cdn-icons-png.flaticon.com/512/3097/3097144.png', // üöó icono auto
  iconSize: [34, 34],
  iconAnchor: [17, 17]
});

const startIcon = L.icon({
  iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', // üìç icono inicio
  iconSize: [24, 24],
  iconAnchor: [12, 12]
});

const colors = ["#007bff","#28a745","#ff5722","#ffb700","#8a2be2","#00bcd4","#ff1493","#795548"];
const colorMap = new Map();
function colorFor(id){
  if(!colorMap.has(id))
    colorMap.set(id, colors[colorMap.size % colors.length]);
  return colorMap.get(id);
}

// -------- FUNCIONES DE DIBUJO --------
function addOrUpdateCar(id, lat, lng, meta, ts){
  const name = meta?.display || id;
  const popup = `<b>${name}</b><br>${meta?.brigada||''} / ${meta?.zona||''} / ${meta?.contrata||''}<br>${new Date(ts).toLocaleString()}`;
  
  // Si no existe el marcador
  let marker = markers.get(id);
  if(!marker){
    marker = L.marker([lat, lng], { icon: carIcon }).addTo(map).bindPopup(popup);
    markers.set(id, marker);
  }else{
    marker.setLatLng([lat, lng]).setPopupContent(popup);
  }

  // A√±adir recorrido
  let line = trails.get(id);
  if(!line){
    const color = colorFor(id);
    line = L.polyline([[lat, lng]], { color, weight: 4, opacity: 0.8 }).addTo(map);
    trails.set(id, line);

    // PUNTO INICIAL
    const start = L.marker([lat, lng], { icon: startIcon }).addTo(map);
    startPoints.set(id, start);
  }else{
    const arr = line.getLatLngs();
    arr.push([lat, lng]);
    if(arr.length > 2000) arr.splice(0, arr.length - 2000);
    line.setLatLngs(arr);
  }

  lastSeen.set(id, { ts, meta, lat, lng });
  renderSidebar();
}

// -------- PANEL DE CONECTADOS --------
function renderSidebar(){
  const div = document.getElementById('onlineList');
  div.innerHTML = '';
  const now = Date.now();

  if(lastSeen.size === 0){
    div.innerHTML = '<p style="color:#8a96a8">Sin brigadas conectadas.</p>';
    return;
  }

  [...lastSeen.entries()]
    .sort((a,b)=>b[1].ts - a[1].ts)
    .forEach(([id, obj])=>{
      const color = colorFor(id);
      const age = (now - obj.ts) / 1000;
      const online = age < 60;
      const el = document.createElement('div');
      el.style.padding = '6px 8px';
      el.style.marginBottom = '6px';
      el.style.borderLeft = `4px solid ${color}`;
      el.style.borderRadius = '6px';
      el.style.background = online ? '#122940' : '#1b1f2b';
      el.style.cursor = 'pointer';
      el.innerHTML = `
        <div><b style="color:${color}">${obj.meta?.display || id}</b></div>
        <div style="color:#b7c1d1">${obj.meta?.brigada||''} / ${obj.meta?.zona||''} / ${obj.meta?.contrata||''}</div>
        <div style="color:#7e8ba0;font-size:.8rem">${online?'üü¢ En l√≠nea':'‚ö´ Inactivo'} ‚Äî ${new Date(obj.ts).toLocaleTimeString()}</div>
      `;
      el.onclick = ()=>{ 
        const mk = markers.get(id);
        if(mk){ map.setView(mk.getLatLng(), 17); mk.openPopup(); }
      };
      div.appendChild(el);
    });
}

// -------- WEBSOCKET EN VIVO --------
const ws = new WebSocket((location.protocol==='https:'?'wss':'ws')+'://'+location.host+'/ws');

ws.onopen = ()=> console.log("‚úÖ WS conectado");
ws.onclose = ()=> console.warn("‚ùå WS desconectado");
ws.onmessage = (ev)=>{
  let msg;
  try { msg = JSON.parse(ev.data); } catch { return; }
  if(msg.type !== 'point') return;
  const d = msg.data;
  addOrUpdateCar(d.id, d.lat, d.lng, d.meta, d.ts || Date.now());
};
</script>

