<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Monitoreo GPS - Brigadas en Tiempo Real</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: #0e1621;
      color: #fff;
      display: flex;
      height: 100vh;
      overflow: hidden;
    }
    #map { flex: 1; }
    #side {
      width: 300px;
      background: #111c2e;
      padding: 10px;
      overflow-y: auto;
      border-left: 2px solid #1f2a3d;
    }
    h3 { color: #00bcd4; text-align: center; }
    .brigada-card {
      background: #14263f;
      border-left: 4px solid #00bcd4;
      border-radius: 8px;
      margin-bottom: 6px;
      padding: 6px;
      transition: 0.2s;
      cursor: pointer;
    }
    .brigada-card:hover { background: #1d3557; transform: scale(1.02); }
    .ok { background:#4caf50; }
    .bad { background:#f44336; }
    #wsdot { width:10px; height:10px; display:inline-block; border-radius:50%; margin-right:5px; }
  </style>
</head>
<body>
  <div id="map"></div>
  <aside id="side">
    <h3>Brigadas conectadas</h3>
    <div><span id="wsdot" class="bad"></span><small id="wslabel">WS: desconectado</small></div>
    <div id="onlineList"><p style="color:#8a96a8">Sin brigadas conectadas.</p></div>
  </aside>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
  const map = L.map('map').setView([-12.0464, -77.0428], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {maxZoom:19}).addTo(map);

  const carIcon = L.icon({ iconUrl:'https://cdn-icons-png.flaticon.com/512/3097/3097144.png', iconSize:[34,34], iconAnchor:[17,17] });
  const startIcon = L.icon({ iconUrl:'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize:[24,24], iconAnchor:[12,12] });

  const markers=new Map(), trails=new Map(), starts=new Map(), lastSeen=new Map(), colors=new Map();
  const palette=["#007bff","#ff5722","#28a745","#ffb700","#8a2be2","#00bcd4","#ff1493","#795548"];
  const colorFor=id=>colors.get(id)||colors.set(id,palette[colors.size%palette.length]).get(id);

  function moveSmoothly(marker,toLat,toLng){
    const from=marker.getLatLng(), steps=10;
    let i=0; const dLat=(toLat-from.lat)/steps,dLng=(toLng-from.lng)/steps;
    const anim=setInterval(()=>{
      marker.setLatLng([from.lat+dLat*i, from.lng+dLng*i]);
      if(++i>steps) clearInterval(anim);
    },100);
  }

  function addOrUpdate(id,lat,lng,meta,ts){
    const popup=`<b>${meta.display||id}</b><br>${meta.brigada||''} / ${meta.zona||''} / ${meta.contrata||''}<br>${new Date(ts).toLocaleTimeString()}`;
    let mk=markers.get(id);
    if(!mk){ mk=L.marker([lat,lng],{icon:carIcon}).addTo(map).bindPopup(popup); markers.set(id,mk); }
    else { moveSmoothly(mk,lat,lng); mk.setPopupContent(popup); }

    let pl=trails.get(id);
    if(!pl){
      pl=L.polyline([[lat,lng]],{color:colorFor(id),weight:4,opacity:.8}).addTo(map);
      trails.set(id,pl);
      const st=L.marker([lat,lng],{icon:startIcon}).addTo(map);
      starts.set(id,st);
    } else {
      const arr=pl.getLatLngs(); arr.push([lat,lng]);
      if(arr.length>2000) arr.splice(0,arr.length-2000);
      pl.setLatLngs(arr);
    }

    lastSeen.set(id,{lat,lng,ts,meta});
    renderSidebar();
  }

  function renderSidebar(){
    const list=document.getElementById('onlineList');
    list.innerHTML='';
    const now=Date.now();
    if(!lastSeen.size){ list.innerHTML='<p style="color:#8a96a8">Sin brigadas conectadas.</p>'; return; }
    [...lastSeen.entries()].sort((a,b)=>b[1].ts-a[1].ts).forEach(([id,o])=>{
      const color=colorFor(id), online=(now-o.ts)<60000;
      const div=document.createElement('div');
      div.className='brigada-card';
      div.style.borderLeftColor=color;
      div.innerHTML=`<b style="color:${color}">${o.meta.display}</b><br>
      <small>${o.meta.brigada||''} / ${o.meta.zona||''} / ${o.meta.contrata||''}</small><br>
      <span style="color:${online?'#0f0':'#888'}">${online?'ðŸŸ¢ En lÃ­nea':'âš« Inactivo'}</span>`;
      div.onclick=()=>{ const mk=markers.get(id); if(mk){ map.setView(mk.getLatLng(),16,{animate:true}); mk.openPopup(); } };
      list.appendChild(div);
    });
  }

  // --- WEBSOCKET ---
  const wsUrl=(location.protocol==='https:'?'wss':'ws')+'://'+location.host+'/ws';
  const ws=new WebSocket(wsUrl);
  const dot=document.getElementById('wsdot'),label=document.getElementById('wslabel');
  ws.onopen=()=>{dot.className='ok';label.textContent='WS: conectado';};
  ws.onclose=()=>{dot.className='bad';label.textContent='WS: desconectado';setTimeout(()=>location.reload(),3000);};
  ws.onmessage=e=>{
    let msg;try{msg=JSON.parse(e.data);}catch{return;}
    if(msg.type==='snapshot') Object.entries(msg.data).forEach(([id,p])=>addOrUpdate(id,p.lat,p.lng,p.meta,p.ts));
    if(msg.type==='point'){const d=msg.data;addOrUpdate(d.id,d.lat,d.lng,d.meta,d.ts);}
  };
  </script>
</body>
</html>
