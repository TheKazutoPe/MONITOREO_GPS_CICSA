<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CICSA Monitoreo GPS</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<!-- Supabase -->
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>

<!-- JSZip para exportar KMZ -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<style>
  html, body { height: 100%; margin: 0; font-family: "Segoe UI", system-ui, -apple-system, Roboto, Arial; background:#0e1b26; }
  #map { height: 100%; width: 100%; }

  .topbar{
    position: absolute; inset:10px 10px auto 10px; z-index: 1000;
    display:flex; align-items:center; gap:12px; padding:10px 12px;
    background: rgba(13, 30, 44, .92); color:#eaf6ff; border:1px solid #1d3a4f;
    border-radius:12px; backdrop-filter: blur(6px); box-shadow: 0 6px 14px rgba(0,0,0,.25);
  }
  .brand{ display:flex; align-items:center; gap:10px; padding-right:8px; border-right:1px solid #254a63; }
  .brand img{ height:26px; }
  .bar-group{ display:flex; align-items:center; gap:8px; }
  .bar-group label{ font-size:13px; opacity:.8; }
  .bar-group select{
    background:#0b1f2e; color:#d8f0ff; border:1px solid #24465d;
    border-radius:8px; padding:6px 8px; outline:none;
  }
  .btn{
    background:#1db57a; color:#072018; border:none; padding:7px 12px;
    border-radius:10px; font-weight:700; cursor:pointer; box-shadow: 0 2px 0 #118a59 inset;
  }
  .panel{
    position:absolute; right:12px; top:64px; z-index:1000; width:300px;
    background:rgba(13,30,44,.92); color:#eaf6ff; border:1px solid #1d3a4f;
    border-radius:12px; padding:12px; box-shadow:0 6px 14px rgba(0,0,0,.25);
    max-height:78%; overflow:auto;
  }
  .panel h3{ margin:0 0 10px; font-size:16px; display:flex; align-items:center; gap:8px; }
  .dot{ width:9px; height:9px; border-radius:50%; background:#25d366; display:inline-block; }
  .user{
    display:flex; align-items: flex-start; gap:10px; padding:8px; border-radius:10px;
    border:1px solid #21465f; margin:8px 0; cursor:pointer; background:#0b1f2e;
  }
  .user:hover{ background:#0d2536; }
  .user b{ display:block; margin-bottom:2px; }
  .user small{ opacity:.8; }
  .car-icon img{
    width:100%; height:100%;
    transform-origin: 50% 50%;
    will-change: transform;
    filter: drop-shadow(0 2px 2px rgba(0,0,0,.45));
    transition: transform .15s linear;
    pointer-events: none;
    user-select: none;
  }
</style>
</head>

<body>
  <div id="map"></div>

  <div class="topbar">
    <div class="brand">
      <img src="/static/logo_cicsa.png" alt="CICSA" />
      <span style="font-weight:700">Monitoreo GPS</span>
    </div>
    <button id="btnCenter" class="btn">Centrar</button>
  </div>

  <div class="panel">
    <h3><span class="dot"></span> Brigadas conectadas</h3>
    <div id="lista"></div>
  </div>

<script>
/* ====== CONFIGURACIÓN SUPABASE ====== */
const SUPABASE_URL = "https://fcyerlaliiiuutdzinvg.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZjeWVybGFsaWlpdXV0ZHppbnZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwMTMyMzUsImV4cCI6MjA2OTU4OTIzNX0.fgKF7aE7kiUYGpgom34taZw-1PsYJJ1wlwI5urADc6s";

const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* ====== MAPA ====== */
const map = L.map('map').setView([-12.0464, -77.0428], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

const carIcon = L.icon({
  iconUrl: '/static/carro.png',
  iconSize: [40, 40],
  iconAnchor: [20, 20],
});

let marker = null;

/* ====== CARGAR COORDENADAS ====== */
async function cargarUltimaUbicacion() {
  try {
    const { data, error } = await supabase
      .from('ubicaciones_brigadas')
      .select('latitud, longitud, tecnico, brigada, contrata, zona, cargo, created_at')
      .order('id', { ascending: false })
      .limit(1);

    if (error) throw error;

    if (data && data.length > 0) {
      const u = data[0];
      const pos = [u.latitud, u.longitud];
      if (!marker) {
        marker = L.marker(pos, { icon: carIcon }).addTo(map);
      } else {
        marker.setLatLng(pos);
      }

      marker.bindPopup(
        `<b>${u.brigada}</b><br>${u.cargo} - ${u.tecnico}<br>${u.zona} | ${u.contrata}<br><small>${new Date(u.created_at).toLocaleTimeString('es-PE')}</small>`
      );

      map.setView(pos, 14);
      document.getElementById('lista').innerHTML = `
        <div class="user">
          <div style="flex:1">
            <b>${u.brigada}</b>
            <div>${u.cargo} • ${u.tecnico}</div>
            <small>${u.zona} | ${u.contrata}</small><br>
            <small>Último: ${new Date(u.created_at).toLocaleTimeString('es-PE')}</small>
          </div>
        </div>`;
    }
  } catch (err) {
    console.error('Error cargando ubicación:', err);
  }
}

/* ====== AUTOACTUALIZAR ====== */
setInterval(cargarUltimaUbicacion, 5000);
cargarUltimaUbicacion();

document.getElementById('btnCenter').onclick = () => {
  if (marker) map.setView(marker.getLatLng(), 15);
};
</script>
</body>
</html>