<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>CICSA Â· Monitoreo GPS</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html,body{height:100%;margin:0;font-family:"Segoe UI",sans-serif}
    #map{height:100%;width:100%}
    #sidebar{
      position:absolute;
      right:10px;top:10px;
      width:300px;max-height:95%;
      background:#0b1b2a;color:#fff;
      border-radius:10px;padding:10px;
      overflow:auto;z-index:999;
    }
    h4{text-align:center;color:#00e676;margin:0 0 8px;}
    .item{background:#112d4e;padding:8px;border-radius:8px;margin:4px 0}
    .online{color:#00e676;font-size:12px}
    .topbar{
      position:absolute;left:10px;top:10px;z-index:999;
      background:#fff;border-radius:10px;padding:8px;display:flex;gap:6px;align-items:center;
      box-shadow:0 2px 10px rgba(0,0,0,.3);
    }
    select,button{padding:6px;border-radius:6px;border:1px solid #ccc}
    button{background:#00b050;color:#fff;border:none}
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="sidebar">
    <h4>ðŸ›° Brigadas Conectadas</h4>
    <div id="list"></div>
  </div>

  <div class="topbar">
    <img src="/static/logo_cicsa.png" alt="CICSA" height="28">
    <select id="zona"><option value="">Zona</option></select>
    <select id="contrata"><option value="">Contrata</option></select>
    <select id="brigada"><option value="">Brigada</option></select>
    <button id="refresh">Actualizar</button>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const map = L.map("map").setView([-12.06,-77.04], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    const carIcon = L.icon({
      iconUrl: 'https://cdn-icons-png.flaticon.com/512/3097/3097144.png',
      iconSize: [34,34],
      iconAnchor: [17,17]
    });

    const markers = {}, trails = {}, coords = {};
    const listDiv = document.getElementById("list");

    function renderList() {
      listDiv.innerHTML = '';
      for (const id in markers) {
        const meta = markers[id].meta;
        const el = document.createElement('div');
        el.className = 'item';
        el.innerHTML = `<b>${meta.display || id}</b><br>${meta.contrata || 'â€”'} / ${meta.zona || 'â€”'} / ${meta.brigada || 'â€”'}<br><span class="online">ðŸŸ¢ En lÃ­nea</span>`;
        listDiv.appendChild(el);
      }
    }

    function drawLive(id, lat, lng, meta) {
      if (!markers[id]) {
        const m = L.marker([lat, lng], { icon: carIcon }).addTo(map);
        m.bindPopup(`<b>${meta.display}</b><br>${meta.contrata || ''} / ${meta.zona || ''}`);
        markers[id] = { marker: m, meta };
      } else {
        markers[id].marker.setLatLng([lat, lng]);
      }

      (coords[id] ||= []).push([lat, lng]);
      if (coords[id].length > 500) coords[id].shift();

      if (trails[id]) trails[id].setLatLngs(coords[id]);
      else trails[id] = L.polyline(coords[id], { color: '#002D62', weight: 3 }).addTo(map);

      renderList();
    }

    function wsURL(){return (location.protocol==='https:'?'wss':'ws')+'://'+location.host+'/ws';}
    function connectWS(){
      const ws = new WebSocket(wsURL());
      ws.onopen = ()=>console.log('WS conectado');
      ws.onmessage = e=>{
        let msg; try{ msg = JSON.parse(e.data); }catch{return;}
        if(msg.type==='snapshot'){
          for(const [id,v] of Object.entries(msg.data)) drawLive(id,v.lat,v.lng,v.meta);
        }
        if(msg.type==='point'){
          const v = msg.data;
          drawLive(v.id,v.lat,v.lng,v.meta);
        }
      };
      ws.onclose = ()=>setTimeout(connectWS,2000);
    }
    connectWS();

    document.getElementById('refresh').onclick = async ()=>{
      const res = await fetch('/api/recorridos');
      const j = await res.json();
      if(!j.ok) return;
      for(const [id,arr] of Object.entries(j.data)){
        for(const p of arr){ drawLive(id,p.lat,p.lng,p.meta); }
      }
    };
  </script>
</body>
</html>

