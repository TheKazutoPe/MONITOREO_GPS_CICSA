<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Mapa de Brigadas</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    html, body { margin:0; height:100%; }
    #map { height:100%; }
    #sidebar {
      position:absolute; top:0; right:0; width:260px; height:100%;
      background:#0b1b2a; color:white; padding:10px; overflow-y:auto;
    }
    .item { background:#102840; margin:6px 0; padding:8px; border-radius:6px; }
    .online { color:lime; font-size:10px; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="sidebar"><h5>ðŸ›° Brigadas conectadas</h5><div id="list"></div></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
  const map = L.map('map').setView([-12.06, -77.04], 12);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19
  }).addTo(map);

  const markers = {};
  const listDiv = document.getElementById('list');

  function updateList() {
    listDiv.innerHTML = '';
    Object.values(markers).forEach(m => {
      const d = m.meta;
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `<b>${d.display}</b><br>${d.contrata || ''} / ${d.zona || ''}<br><span class="online">En lÃ­nea</span>`;
      listDiv.appendChild(div);
    });
  }

  function drawMarker(id, lat, lng, meta) {
    if (!markers[id]) {
      const icon = L.icon({ iconUrl: 'img/icon-car.png', iconSize: [28,28], iconAnchor:[14,14] });
      const marker = L.marker([lat,lng], { icon }).addTo(map);
      marker.bindPopup(`<b>${meta.display}</b><br>${meta.contrata} / ${meta.zona}`);
      markers[id] = { marker, meta };
    } else {
      markers[id].marker.setLatLng([lat,lng]);
    }
    updateList();
  }

  // --- WebSocket realtime ---
  const ws = new WebSocket((location.protocol === "https:" ? "wss://" : "ws://") + location.host + "/ws");
  ws.onmessage = (e) => {
    const msg = JSON.parse(e.data);
    if (msg.type === "snapshot") {
      for (const [id, v] of Object.entries(msg.data)) drawMarker(id, v.lat, v.lng, v.meta);
    }
    if (msg.type === "point") {
      const v = msg.data; drawMarker(v.id, v.lat, v.lng, v.meta);
    }
  };
  </script>
</body>
</html>
