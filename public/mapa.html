<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Monitoreo GPS CICSA</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
  html, body { height: 100%; margin: 0; font-family: 'Segoe UI', sans-serif; }
  #map { height: 100%; width: 100%; }

  .topbar {
    position: absolute; top: 10px; left: 10px; right: 10px;
    background: rgba(16,35,49,0.9);
    border-radius: 10px; padding: 8px 12px;
    display: flex; align-items: center; gap: 12px;
    z-index: 1000;
    color: white;
  }

  .topbar img { height: 28px; }
  .topbar select, .topbar button {
    background: #0c1c28; color: white;
    border: 1px solid #28455a; border-radius: 8px;
    padding: 4px 8px;
  }
  .topbar button {
    background: #1ca86a; border: none; cursor: pointer; font-weight: bold;
  }

  .panel {
    position: absolute; right: 15px; top: 65px; z-index: 1000;
    width: 280px; background: rgba(16,35,49,0.9);
    color: white; padding: 10px; border-radius: 10px;
    font-size: 13px; overflow-y: auto; max-height: 80%;
  }

  .user { padding: 6px; border-bottom: 1px solid #224; cursor: pointer; }
  .user:hover { background: rgba(255,255,255,0.1); }
</style>
</head>
<body>
<div id="map"></div>

<div class="topbar">
  <img src="https://upload.wikimedia.org/wikipedia/commons/2/20/Car_icon.png" alt="logo">
  <b>CICSA Monitoreo GPS</b>
  <label>Zona:</label>
  <select id="zona"><option value="">Todas</option></select>
  <label>Contrata:</label>
  <select id="contrata"><option value="">Todas</option></select>
  <button id="centrar">Centrar</button>
</div>

<div class="panel" id="panel">
  <b>ðŸŸ¢ Brigadas conectadas</b>
  <div id="usuarios"></div>
</div>

<script>
const API = location.origin;
const WS_URL = `${location.protocol === 'https:' ? 'wss:' : 'ws:'}//${location.host}/ws`;
const map = L.map('map').setView([-12.0464, -77.0428], 12);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  maxZoom: 19, attribution: 'Â© OpenStreetMap'
}).addTo(map);

const markers = {};
const rutas = {};

function iconoCarro() {
  return L.icon({
    iconUrl: 'https://cdn-icons-png.flaticon.com/512/854/854894.png',
    iconSize: [38, 38],
    iconAnchor: [19, 19],
  });
}

function agregarOModificar(id, lat, lng, meta) {
  if (!lat || !lng) return;
  const pos = [lat, lng];
  const texto = `
    <b>${meta.display || 'Sin nombre'}</b><br>
    ${meta.cargo || ''}<br>
    ${meta.brigada || ''} | ${meta.zona || ''}<br>
    ${meta.contrata || ''}<br>
    <small>${new Date(meta.ts || Date.now()).toLocaleTimeString()}</small>
  `;

  if (!markers[id]) {
    const mk = L.marker(pos, { icon: iconoCarro() }).addTo(map).bindPopup(texto);
    const pl = L.polyline([pos], { color: '#007bff', weight: 3 }).addTo(map);
    markers[id] = mk;
    rutas[id] = pl;
  } else {
    markers[id].setLatLng(pos).bindPopup(texto);
    rutas[id].addLatLng(pos);
  }
}

async function cargarInicial() {
  try {
    const res = await fetch(`${API}/api/conectados`);
    const json = await res.json();
    if (!json.ok) return;
    document.getElementById('usuarios').innerHTML = '';
    json.data.forEach(u => {
      const li = document.createElement('div');
      li.className = 'user';
      li.innerHTML = `<b>${u.meta.display}</b><br>${u.meta.brigada || ''} - ${u.meta.contrata || ''}`;
      li.onclick = () => { map.setView([u.lat, u.lng], 15); };
      document.getElementById('usuarios').appendChild(li);
      agregarOModificar(u.id, u.lat, u.lng, { ...u.meta, ts: Date.now() });
    });
  } catch (e) {
    console.error('Error al cargar conectados:', e);
  }
}

// WebSocket
const ws = new WebSocket(WS_URL);
ws.onopen = () => console.log('WS conectado');
ws.onmessage = e => {
  try {
    const msg = JSON.parse(e.data);
    if (msg.type === 'snapshot') {
      const snap = msg.data;
      for (const id in snap) {
        const d = snap[id];
        agregarOModificar(id, d.lat, d.lng, d.meta);
      }
    } else if (msg.type === 'point') {
      const d = msg.data;
      agregarOModificar(d.id, d.lat, d.lng, d.meta);
    }
  } catch (err) {
    console.error('Error WS:', err);
  }
};

document.getElementById('centrar').onclick = () => {
  const ids = Object.keys(markers);
  if (!ids.length) return;
  const bounds = L.latLngBounds(ids.map(i => markers[i].getLatLng()));
  map.fitBounds(bounds.pad(0.2));
};

cargarInicial();
</script>
</body>
</html>
