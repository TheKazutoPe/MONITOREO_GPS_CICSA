<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CICSA Monitoreo GPS</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- NUEVO: JSZip para generar KMZ en cliente -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<style>
  html, body { height: 100%; margin: 0; font-family: "Segoe UI", system-ui, -apple-system, Roboto, Arial; background:#0e1b26; }
  #map { height: 100%; width: 100%; }

  /* Barra superior */
  .topbar{
    position: absolute; inset:10px 10px auto 10px; z-index: 1000;
    display:flex; align-items:center; gap:12px; padding:10px 12px;
    background: rgba(13, 30, 44, .92); color:#eaf6ff; border:1px solid #1d3a4f;
    border-radius:12px; backdrop-filter: blur(6px); box-shadow: 0 6px 14px rgba(0,0,0,.25);
  }
  .brand{
    display:flex; align-items:center; gap:10px; padding-right:8px; border-right:1px solid #254a63;
  }
  .brand img{ height:26px; }
  .brand .fallback{ font-weight:700; letter-spacing:.2px; }
  .bar-group{ display:flex; align-items:center; gap:8px; }
  .bar-group label{ font-size:13px; opacity:.8; }
  .bar-group select{
    background:#0b1f2e; color:#d8f0ff; border:1px solid #24465d;
    border-radius:8px; padding:6px 8px; outline:none;
  }
  .btn{
    background:#1db57a; color:#072018; border:none; padding:7px 12px;
    border-radius:10px; font-weight:700; cursor:pointer; box-shadow: 0 2px 0 #118a59 inset;
  }
  .btn:active{ transform: translateY(1px); }

  /* Panel lateral */
  .panel{
    position:absolute; right:12px; top:64px; z-index:1000; width:300px;
    background:rgba(13,30,44,.92); color:#eaf6ff; border:1px solid #1d3a4f;
    border-radius:12px; padding:12px; box-shadow:0 6px 14px rgba(0,0,0,.25);
    max-height:78%; overflow:auto;
  }
  .panel h3{ margin:0 0 10px; font-size:16px; display:flex; align-items:center; gap:8px; }
  .dot{ width:9px; height:9px; border-radius:50%; background:#25d366; display:inline-block; }
  .user{
    display:flex; align-items: flex-start; gap:10px; padding:8px; border-radius:10px;
    border:1px solid #21465f; margin:8px 0; cursor:pointer; background:#0b1f2e;
  }
  .user:hover{ background:#0d2536; }
  .user b{ display:block; margin-bottom:2px; }
  .user small{ opacity:.8; }

  /* Popups */
  .leaflet-popup-content b{ font-weight:700; }

  /* === Icono de carrito rotatorio === */
  .car-icon { background: transparent; border: none; }
  .car-icon img{
    width:40px; height:40px;
    transform-origin: 50% 50%;
    will-change: transform;
    filter: drop-shadow(0 2px 2px rgba(0,0,0,.45));
    transition: transform .15s linear;
    pointer-events: none;
    user-select: none;
  }
</style>
</head>
<body>
  <div id="map"></div>

  <div class="topbar">
    <div class="brand">
      <img src="/static/logo_cicsa.png" alt="CICSA Logo" onerror="this.replaceWith(Object.assign(document.createElement('span'),{className:'fallback',textContent:'CICSA Monitoreo GPS'}))">
      <span class="fallback" style="display:none;">CICSA Monitoreo GPS</span>
    </div>

    <div class="bar-group">
      <label>Zona:</label>
      <select id="selZona">
        <option value="">Todas</option>
        <option value="LIMA">LIMA</option>
        <option value="NORTE">NORTE</option>
        <option value="SUR">SUR</option>
        <option value="CENTRO">CENTRO</option>
      </select>
    </div>
    <div class="bar-group">
      <label>Contrata:</label>
      <select id="selContrata">
        <option value="">Todas</option>
        <option value="CICSA">CICSA</option>
        <option value="SAFESA">SAFESA</option>
        <option value="COMATEL">COMATEL</option>
        <option value="DOLAN">DOLAN</option>
        <option value="ECYTEL">ECYTEL</option>
      </select>
    </div>

    <button id="btnCenter" class="btn">Centrar</button>
    <!-- NUEVO: Exportar KMZ -->
    <button id="btnKMZ" class="btn" title="Exportar KMZ del recorrido actual">Exportar KMZ</button>
  </div>

  <div class="panel">
    <h3><span class="dot"></span> Brigadas conectadas</h3>
    <div id="lista"></div>
  </div>

<script>
/* ======= CONFIG ======= */
const API = location.origin;
const WS_URL = `${location.protocol === 'https:' ? 'wss:' : 'ws:'}//${location.host}/ws`;

/* Carro top view (URL pública) */
const CAR_ICON_URL = 'https://cdn-icons-png.flaticon.com/512/3202/3202926.png';

/* ======= MAPA ======= */
const map = L.map('map').setView([-12.0464, -77.0428], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:"© OpenStreetMap"}).addTo(map);

const state = new Map(); // id -> { marker, line, meta, lastLatLng, lastTs, visible }
const listaEl = document.getElementById('lista');
const selZona = document.getElementById('selZona');
const selContrata = document.getElementById('selContrata');

/* ======= ICONO CARRITO (divIcon para rotación) ======= */
function carDivIcon(){
  return L.divIcon({
    className: 'car-icon',
    html: `<img src="${CAR_ICON_URL}" alt="car">`,
    iconSize: [40, 40],
    iconAnchor: [20, 20] // centro
  });
}

/* ======= UTILS ======= */
function fmtHora(ts){
  if(!ts) return '-';
  const d = typeof ts==='number' ? new Date(ts) : new Date(ts);
  return d.toLocaleTimeString("es-PE",{ timeZone:"America/Lima" });
}
function popupHtml(meta, ts){
  return `
    <b>${meta.brigada || meta.display || '—'}</b><br>
    ${meta.cargo || ''}${meta.tecnico ? ' • ' + meta.tecnico : ''}<br>
    ${meta.zona || ''} | ${meta.contrata || ''}<br>
    <small>Último: ${fmtHora(ts)}</small>
  `;
}
function bearing(from, to){
  const toRad = x => x*Math.PI/180, toDeg = x => x*180/Math.PI;
  const φ1 = toRad(from[0]), φ2 = toRad(to[0]);
  const Δλ = toRad(to[1]-from[1]);
  const y = Math.sin(Δλ)*Math.cos(φ2);
  const x = Math.cos(φ1)*Math.sin(φ2) - Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);
  return (toDeg(Math.atan2(y, x)) + 360) % 360;
}
function animateMarker(marker, from, to, duration=700, onEnd){
  const start = performance.now();
  function step(t){
    const p = Math.min((t - start) / duration, 1);
    const lat = from[0] + (to[0]-from[0]) * p;
    const lng = from[1] + (to[1]-from[1]) * p;
    marker.setLatLng([lat,lng]);
    if (p < 1) requestAnimationFrame(step);
    else onEnd && onEnd();
  }
  requestAnimationFrame(step);
}
function rotateMarker(marker, angleDeg){
  const el = marker.getElement();
  if (!el) return;
  const img = el.querySelector('img');
  if (img) img.style.transform = `rotate(${angleDeg}deg)`;
}

/* ======= FILTROS VISUALES (ocultan/mostrar capas) ======= */
function matchesFilters(meta){
  const fZona = selZona.value.trim();
  const fCon  = selContrata.value.trim();
  if (fZona && (meta.zona || '') !== fZona) return false;
  if (fCon  && (meta.contrata || '') !== fCon) return false;
  return true;
}
function setVisible(entry, visible){
  const { marker, line } = entry;
  if (visible){
    if (!map.hasLayer(marker)) marker.addTo(map);
    if (!map.hasLayer(line))   line.addTo(map);
  } else {
    if (map.hasLayer(marker)) marker.remove();
    if (map.hasLayer(line))   line.remove();
  }
  entry.visible = visible;
}
function applyFilters(){
  state.forEach((entry)=>{
    setVisible(entry, matchesFilters(entry.meta || {}));
  });
  renderList();
}

/* ======= CAPAS ======= */
function ensureLayer(u){
  const id = u.id;
  const meta = u.meta || {};
  const lat = u.lat, lng = u.lng;
  if (lat==null || lng==null) return;

  const pos = [lat, lng];
  if (!state.has(id)){
    const marker = L.marker(pos,{icon:carDivIcon(), zIndexOffset:1000})
      .addTo(map)
      .bindPopup(popupHtml(meta, u.ts || Date.now()));
    const line = L.polyline([pos], {color:'#0b3d91', weight:4, opacity:.9}).addTo(map);

    rotateMarker(marker, 0);

    const entry = { marker, line, meta, lastLatLng:pos, lastTs: u.ts || Date.now(), visible:true };
    state.set(id, entry);
    setVisible(entry, matchesFilters(meta)); // aplicar filtro inicial
  } else {
    const s = state.get(id);
    const prev = s.lastLatLng || pos;

    const ang = bearing(prev, pos);
    rotateMarker(s.marker, ang);

    animateMarker(s.marker, prev, pos, 700, () => {
      s.marker.setPopupContent(popupHtml(meta, u.ts || Date.now()));
      s.line.addLatLng(pos);
    });

    s.meta = meta;
    s.lastLatLng = pos;
    s.lastTs = u.ts || Date.now();
    setVisible(s, matchesFilters(s.meta)); // re-evaluar visibilidad
  }
}

function renderList(){
  const fZona = selZona.value.trim();
  const fCon = selContrata.value.trim();

  listaEl.innerHTML = '';
  const items = [];
  state.forEach((s, id)=>{
    const { meta, lastTs, lastLatLng, visible } = s;
    if (fZona && (meta.zona||'') !== fZona) return;
    if (fCon && (meta.contrata||'') !== fCon) return;
    items.push({id, meta, lastTs, lastLatLng, visible});
  });

  items.sort((a,b)=> (b.lastTs||0)-(a.lastTs||0));

  for (const it of items){
    const div = document.createElement('div');
    div.className = 'user';
    div.innerHTML = `
      <div style="flex:1">
        <b>${it.meta.brigada || it.meta.display || '—'}</b>
        <div>${it.meta.cargo || ''}${it.meta.tecnico ? ' • ' + it.meta.tecnico : ''}</div>
        <small>${it.meta.zona || ''} | ${it.meta.contrata || ''}</small><br>
        <small>Último: ${fmtHora(it.lastTs)}</small>
      </div>
    `;
    div.onclick = () => {
      const s = state.get(it.id);
      if (!s || !s.lastLatLng) return;
      map.setView(s.lastLatLng, Math.max(map.getZoom(), 16), { animate: true });
      if (s.marker) s.marker.openPopup();
    };
    listaEl.appendChild(div);
  }
}

/* ======= CONTROLES ======= */
document.getElementById('btnCenter').onclick = centerAll;
document.getElementById('btnKMZ').onclick = exportKMZ;
selZona.onchange = applyFilters;
selContrata.onchange = applyFilters;

function centerAll(){
  const pts = [];
  state.forEach(s=>{ if(s.lastLatLng && s.visible!==false) pts.push(s.lastLatLng); });
  if (!pts.length) return;
  const b = L.latLngBounds(pts);
  map.fitBounds(b.pad(0.2));
}

/* ======= CARGA INICIAL ======= */
async function loadInicial(){
  try{
    const r = await fetch(`${API}/api/conectados`);
    const js = await r.json();
    if (js && js.ok){
      (js.data || []).forEach(u => {
        ensureLayer({ id: u.id, lat: u.lat, lng: u.lng, meta: u.meta, ts: Date.now() });
      });
      applyFilters();
      centerAll();
    }
  }catch(e){ console.error('Error conectados:', e); }
}

/* ======= WS tiempo real ======= */
const ws = new WebSocket(WS_URL);
ws.onopen = ()=> console.log('WS conectado');
ws.onmessage = ev => {
  try{
    const msg = JSON.parse(ev.data);
    if (msg.type === 'snapshot'){
      const snap = msg.data || {};
      Object.entries(snap).forEach(([id, d])=>{
        ensureLayer({ id, lat:d.lat, lng:d.lng, meta:d.meta, ts: Date.now() });
      });
      applyFilters();
    } else if (msg.type === 'remove'){
      const { id } = msg.data || {};
      const s = state.get(id);
      if (s){
        if (s.marker) s.marker.remove();
        if (s.line)   s.line.remove();
        state.delete(id);
        renderList();
      }
    } else if (msg.type === 'point'){
      const d = msg.data || {};
      ensureLayer({ id:d.id, lat:d.lat, lng:d.lng, meta:d.meta, ts: d.ts || Date.now() });
      applyFilters();
    }
  }catch(e){ console.error('WS parse error', e); }
};

/* refresca el “Último: …” cada 10s */
setInterval(renderList, 10_000);

loadInicial();

/* ======= NUEVO: Exportar KMZ =======
   - Recorre 'state', toma los puntos de cada polyline y el último punto.
   - Crea doc.kml y lo empaqueta en KMZ (ZIP) con JSZip. */
function exportKMZ(){
  // Construir KML
  const kmlParts = [];
  kmlParts.push(`<?xml version="1.0" encoding="UTF-8"?>`);
  kmlParts.push(`<kml xmlns="http://www.opengis.net/kml/2.2"><Document><name>Recorridos CICSA</name>`);

  state.forEach((s, id) => {
    // saltar los ocultos por filtro para export actual visible
    if (s.visible === false) return;

    const name = s.meta?.brigada || s.meta?.display || id;
    const coords = (s.line && s.line.getLatLngs ? s.line.getLatLngs() : [])
      .map(ll => `${ll.lng},${ll.lat},0`).join(" ");

    if (coords) {
      kmlParts.push(`<Placemark><name>${escapeXml(name)} - Recorrido</name><Style><LineStyle><width>3</width><color>ff913d0b</color></LineStyle></Style><LineString><tessellate>1</tessellate><coordinates>${coords}</coordinates></LineString></Placemark>`);
    }

    if (s.lastLatLng){
      kmlParts.push(`<Placemark><name>${escapeXml(name)} - Última Posición</name><Point><coordinates>${s.lastLatLng[1]},${s.lastLatLng[0]},0</coordinates></Point></Placemark>`);
    }
  });

  kmlParts.push(`</Document></kml>`);
  const kml = kmlParts.join("");

  // Empaquetar como KMZ (ZIP con doc.kml)
  const zip = new JSZip();
  zip.file("doc.kml", kml);
  zip.generateAsync({ type: "blob" }).then(blob => {
    const a = document.createElement("a");
    const ts = new Date().toLocaleString("sv-SE", { timeZone:"America/Lima" }).replace(/[ :]/g,'-');
    a.href = URL.createObjectURL(blob);
    a.download = `recorridos_cicsa_${ts}.kmz`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
  });
}
function escapeXml(s){
  return String(s||'').replace(/[<>&'"]/g, ch => ({
    '<':'&lt;','>':'&gt;','&':'&amp;',"'" :'&apos;','"':'&quot;'
  }[ch]));
}
</script>
</body>
</html>
