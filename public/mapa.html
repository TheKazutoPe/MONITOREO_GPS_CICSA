<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CICSA Monitoreo GPS</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- JSZip para generar KMZ -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<style>
  html, body { height: 100%; margin: 0; font-family: "Segoe UI", system-ui, -apple-system, Roboto, Arial; background:#0e1b26; }
  #map { height: 100%; width: 100%; }

  .topbar{
    position: absolute; inset:10px 10px auto 10px; z-index: 1000;
    display:flex; align-items:center; gap:12px; padding:10px 12px;
    background: rgba(13, 30, 44, .92); color:#eaf6ff; border:1px solid #1d3a4f;
    border-radius:12px; backdrop-filter: blur(6px); box-shadow: 0 6px 14px rgba(0,0,0,.25);
  }
  .brand{ display:flex; align-items:center; gap:10px; padding-right:8px; border-right:1px solid #254a63; }
  .brand img{ height:26px; }
  .bar-group{ display:flex; align-items:center; gap:8px; }
  .bar-group label{ font-size:13px; opacity:.8; }
  .bar-group select{
    background:#0b1f2e; color:#d8f0ff; border:1px solid #24465d;
    border-radius:8px; padding:6px 8px; outline:none;
  }
  .btn{
    background:#1db57a; color:#072018; border:none; padding:7px 12px;
    border-radius:10px; font-weight:700; cursor:pointer; box-shadow: 0 2px 0 #118a59 inset;
  }
  .panel{
    position:absolute; right:12px; top:64px; z-index:1000; width:300px;
    background:rgba(13,30,44,.92); color:#eaf6ff; border:1px solid #1d3a4f;
    border-radius:12px; padding:12px; box-shadow:0 6px 14px rgba(0,0,0,.25);
    max-height:78%; overflow:auto;
  }
  .panel h3{ margin:0 0 10px; font-size:16px; display:flex; align-items:center; gap:8px; }
  .dot{ width:9px; height:9px; border-radius:50%; background:#25d366; display:inline-block; }
  .user{
    display:flex; align-items: flex-start; gap:10px; padding:8px; border-radius:10px;
    border:1px solid #21465f; margin:8px 0; cursor:pointer; background:#0b1f2e;
  }
  .user:hover{ background:#0d2536; }
  .user b{ display:block; margin-bottom:2px; }
  .user small{ opacity:.8; }

  /* NEW: el tamaño lo controla el icono; aquí que escale al 100% */
  .car-icon img{
    width:100%; height:100%;
    transform-origin: 50% 50%;
    will-change: transform;
    filter: drop-shadow(0 2px 2px rgba(0,0,0,.45));
    transition: transform .15s linear;
    pointer-events: none;
    user-select: none;
  }
</style>
</head>
<body>
  <div id="map"></div>

  <div class="topbar">
    <div class="brand">
      <img src="/static/logo_cicsa.png" alt="CICSA" />
      <span style="font-weight:700">Monitoreo GPS</span>
    </div>

    <div class="bar-group">
      <label>Zona:</label>
      <select id="selZona">
        <option value="">Todas</option>
        <option value="LIMA">LIMA</option>
        <option value="NORTE">NORTE</option>
        <option value="SUR">SUR</option>
        <option value="CENTRO">CENTRO</option>
      </select>
    </div>
    <div class="bar-group">
      <label>Contrata:</label>
      <select id="selContrata">
        <option value="">Todas</option>
        <option value="CICSA">CICSA</option>
        <option value="SAFESA">SAFESA</option>
        <option value="COMATEL">COMATEL</option>
        <option value="DOLAN">DOLAN</option>
        <option value="ECYTEL">ECYTEL</option>
      </select>
    </div>

    <button id="btnCenter" class="btn">Centrar</button>
    <button id="btnKMZ" class="btn" title="Exportar KMZ del día">Exportar KMZ</button>
  </div>

  <div class="panel">
    <h3><span class="dot"></span> Brigadas conectadas</h3>
    <div id="lista"></div>
  </div>

<script>
/* ======= CONFIG ======= */
const API = location.origin;
const WS_URL = `${location.protocol === 'https:' ? 'wss:' : 'ws:'}//${location.host}/ws`;
const CAR_ICON_URL = '/static/carro.png';

/* ======= MAPA ======= */
const map = L.map('map').setView([-12.0464, -77.0428], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:"© OpenStreetMap"}).addTo(map);

const state = new Map(); // id -> { marker, line, meta, lastLatLng, lastTs, visible, heading }

/* ======= ICONO AUTO ESCALABLE (NEW) ======= */
const BASE_ZOOM = 14;       // zoom de referencia
const BASE_SIZE = 28;       // px a BASE_ZOOM
const MIN_SIZE  = 16;       // px
const MAX_SIZE  = 48;       // px

function clamp(n, a, b){ return Math.max(a, Math.min(b, n)); }
function sizeForZoom(z){
  const scale = Math.pow(2, (z - BASE_ZOOM) / 3); // cada +3 zoom ~x2
  return clamp(Math.round(BASE_SIZE * scale), MIN_SIZE, MAX_SIZE);
}
function makeCarIcon(sizePx){
  return L.divIcon({
    className: 'car-icon',
    html: `<img src="${CAR_ICON_URL}" alt="CICSA" />`,
    iconSize: [sizePx, sizePx],
    iconAnchor: [Math.round(sizePx/2), Math.round(sizePx*0.70)],
    popupAnchor: [0, -Math.round(sizePx*0.72)]
  });
}

/* ======= UTILS ======= */
function fmtHora(ts){
  if(!ts) return '-';
  const d = typeof ts==='number' ? new Date(ts) : new Date(ts);
  return d.toLocaleTimeString("es-PE",{ timeZone:"America/Lima" });
}
function popupHtml(meta, ts){
  return `
    <b>${meta.brigada || meta.display || '—'}</b><br>
    ${meta.cargo || ''}${meta.tecnico ? ' • ' + meta.tecnico : ''}<br>
    ${meta.zona || ''} | ${meta.contrata || ''}<br>
    <small>Último: ${fmtHora(ts)}</small>
  `;
}
function bearing(from, to){
  const toRad = x => x*Math.PI/180, toDeg = x => x*180/Math.PI;
  const φ1 = toRad(from[0]), φ2 = toRad(to[0]);
  const Δλ = toRad(to[1]-from[1]);
  const y = Math.sin(Δλ)*Math.cos(φ2);
  const x = Math.cos(φ1)*Math.sin(φ2) - Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);
  return (toDeg(Math.atan2(y, x)) + 360) % 360;
}
function animateMarker(marker, from, to, duration=700, onEnd){
  const start = performance.now();
  function step(t){
    const p = Math.min((t - start) / duration, 1);
    const lat = from[0] + (to[0]-from[0]) * p;
    const lng = from[1] + (to[1]-from[1]) * p;
    marker.setLatLng([lat,lng]);
    if (p < 1) requestAnimationFrame(step);
    else onEnd && onEnd();
  }
  requestAnimationFrame(step);
}
function rotateMarker(marker, angleDeg){
  const el = marker.getElement();
  if (!el) return;
  const img = el.querySelector('img');
  if (img) img.style.transform = `rotate(${angleDeg}deg)`;
}

// === NUEVO: minutos transcurridos desde 00:00 (hora Lima) ===
function minutesSinceLimaMidnight(){
  const now = new Date();
  const limaNow = new Date(now.toLocaleString("en-US", { timeZone: "America/Lima" }));
  const midnight = new Date(limaNow);
  midnight.setHours(0,0,0,0);
  return Math.ceil((limaNow - midnight) / 60000);
}

/* ======= FILTROS VISUALES ======= */
const listaEl = document.getElementById('lista');
const selZona = document.getElementById('selZona');
const selContrata = document.getElementById('selContrata');

function matchesFilters(meta){
  const fZona = selZona.value.trim();
  const fCon  = selContrata.value.trim();
  if (fZona && (meta.zona || '') !== fZona) return false;
  if (fCon  && (meta.contrata || '') !== fCon) return false;
  return true;
}
function setVisible(entry, visible){
  const { marker, line } = entry;
  if (visible){
    if (!map.hasLayer(marker)) marker.addTo(map);
    if (!map.hasLayer(line))   line.addTo(map);
  } else {
    if (map.hasLayer(marker)) marker.remove();
    if (map.hasLayer(line))   line.remove();
  }
  entry.visible = visible;
}
function applyFilters(){
  state.forEach((entry)=>{
    setVisible(entry, matchesFilters(entry.meta || {}));
  });
  renderList();
}

/* ======= CAPAS ======= */
function ensureLayer(u){
  const id = u.id;
  const meta = u.meta || {};
  const lat = u.lat, lng = u.lng;
  if (lat==null || lng==null) return;

  const pos = [lat, lng];
  if (!state.has(id)){
    const size = sizeForZoom(map.getZoom());              // NEW
    const marker = L.marker(pos,{icon:makeCarIcon(size), zIndexOffset:1000})
      .addTo(map)
      .bindPopup(popupHtml(meta, u.ts || Date.now()));
    const line = L.polyline([pos], {color:'#0b3d91', weight:4, opacity:.9}).addTo(map);

    rotateMarker(marker, 0);

    const entry = { marker, line, meta, lastLatLng:pos, lastTs: u.ts || Date.now(), visible:true, heading:0 }; // NEW heading
    state.set(id, entry);
    setVisible(entry, matchesFilters(meta));
  } else {
    const s = state.get(id);
    const prev = s.lastLatLng || pos;

    const ang = bearing(prev, pos);
    s.heading = ang;                 // NEW: guarda heading
    rotateMarker(s.marker, ang);

    animateMarker(s.marker, prev, pos, 700, () => {
      s.marker.setPopupContent(popupHtml(meta, u.ts || Date.now()));
      s.line.addLatLng(pos);
    });

    s.meta = meta;
    s.lastLatLng = pos;
    s.lastTs = u.ts || Date.now();
    setVisible(s, matchesFilters(s.meta));
  }
}

function renderList(){
  const fZona = selZona.value.trim();
  const fCon = selContrata.value.trim();

  listaEl.innerHTML = '';
  const items = [];
  state.forEach((s, id)=>{
    const { meta, lastTs, lastLatLng } = s;
    if (fZona && (meta.zona||'') !== fZona) return;
    if (fCon && (meta.contrata||'') !== fCon) return;
    items.push({id, meta, lastTs, lastLatLng});
  });

  items.sort((a,b)=> (b.lastTs||0)-(a.lastTs||0));

  for (const it of items){
    const div = document.createElement('div');
    div.className = 'user';
    div.innerHTML = `
      <div style="flex:1">
        <b>${it.meta.brigada || it.meta.display || '—'}</b>
        <div>${it.meta.cargo || ''}${it.meta.tecnico ? ' • ' + it.meta.tecnico : ''}</div>
        <small>${it.meta.zona || ''} | ${it.meta.contrata || ''}</small><br>
        <small>Último: ${fmtHora(it.lastTs)}</small>
      </div>
    `;
    div.onclick = () => {
      const s = state.get(it.id);
      if (!s || !s.lastLatLng) return;
      map.setView(s.lastLatLng, Math.max(map.getZoom(), 16), { animate: true });
      if (s.marker) s.marker.openPopup();
    };
    listaEl.appendChild(div);
  }
}

/* ======= CONTROLES ======= */
document.getElementById('btnCenter').onclick = centerAll;
document.getElementById('btnKMZ').onclick = exportKMZ;
selZona.onchange = applyFilters;
selContrata.onchange = applyFilters;

function centerAll(){
  const pts = [];
  state.forEach(s=>{
    if (s.lastLatLng && s.visible!==false) pts.push(s.lastLatLng);
  });
  if (!pts.length) return;
  const b = L.latLngBounds(pts);
  map.fitBounds(b.pad(0.2));
}

/* ======= RESCALAR ÍCONOS EN CADA ZOOM (NEW) ======= */
function rescaleAllMarkers(){
  const size = sizeForZoom(map.getZoom());
  state.forEach(s => {
    s.marker.setIcon(makeCarIcon(size));
    rotateMarker(s.marker, s.heading || 0); // re-aplica rotación
  });
}
map.on('zoomend', rescaleAllMarkers);

/* ======= CARGA INICIAL ======= */
async function loadInicial(){
  try{
    const r = await fetch(`${API}/api/conectados`);
    const js = await r.json();
    if (js && js.ok){
      (js.data || []).forEach(u => {
        ensureLayer({ id: u.id, lat: u.lat, lng: u.lng, meta: u.meta, ts: Date.now() });
      });
      applyFilters();
      centerAll();
      rescaleAllMarkers(); // NEW: ajustar tamaño al zoom inicial
    }
  }catch(e){ console.error('Error conectados:', e); }
}

/* ======= WS tiempo real ======= */
const ws = new WebSocket(WS_URL);
ws.onopen = ()=> {};
ws.onmessage = ev => {
  try{
    const msg = JSON.parse(ev.data);
    if (msg.type === 'snapshot'){
      const snap = msg.data || {};
      Object.entries(snap).forEach(([id, d])=>{
        ensureLayer({ id, lat:d.lat, lng:d.lng, meta:d.meta, ts: Date.now() });
      });
      applyFilters();
      rescaleAllMarkers(); // NEW
    } else if (msg.type === 'remove'){
      const { id } = msg.data || {};
      const s = state.get(id);
      if (s){
        if (s.marker) s.marker.remove();
        if (s.line)   s.line.remove();
        state.delete(id);
        renderList();
      }
    } else if (msg.type === 'point'){
      const d = msg.data || {};
      ensureLayer({ id:d.id, lat:d.lat, lng:d.lng, meta:d.meta, ts: d.ts || Date.now() });
      applyFilters();
    }
  }catch(e){ console.error('WS parse error', e); }
};

// refrescar “Último:” cada 10s
setInterval(renderList, 10_000);

loadInicial();

/* ======= Exportar KMZ ======= */
async function exportKMZ(){
  try{
    const mins = minutesSinceLimaMidnight();
    const q = new URLSearchParams({ minutes: String(mins) });
    const fZona = selZona.value.trim();
    const fCon  = selContrata.value.trim();
    if (fZona) q.set("zona", fZona);
    if (fCon)  q.set("contrata", fCon);

    const url = `${API}/api/recorridos?${q.toString()}`;
    const res = await fetch(url);
    const js  = await res.json();
    if (!js.ok) { alert("No se pudo obtener recorridos."); return; }

    const grouped = js.data || {};
    const ids = Object.keys(grouped);
    if (!ids.length){
      alert("No hay datos de recorridos para hoy con los filtros actuales.");
      return;
    }

    const kmlParts = [];
    kmlParts.push(`<?xml version="1.0" encoding="UTF-8"?>`);
    kmlParts.push(`<kml xmlns="http://www.opengis.net/kml/2.2"><Document><name>Recorridos CICSA - Día</name>`);

    for (const id of ids){
      const arr = grouped[id] || [];
      if (!arr.length) continue;

      const meta0 = arr[arr.length-1]?.meta || arr[0]?.meta || {};
      const name = meta0.brigada || meta0.tecnico || meta0.display || id;

      const coords = arr.map(p => `${p.lng},${p.lat},0`).join(" ");

      if (coords){
        kmlParts.push(
          `<Placemark><name>${escapeXml(name)} - Recorrido del día</name>` +
          `<Style><LineStyle><width>3</width><color>ff913d0b</color></LineStyle></Style>` +
          `<LineString><tessellate>1</tessellate><coordinates>${coords}</coordinates></LineString>` +
          `</Placemark>`
        );
      }

      const last = arr[arr.length-1];
      if (last && last.lat!=null && last.lng!=null){
        kmlParts.push(
          `<Placemark><name>${escapeXml(name)} - Última posición</name>` +
          `<Point><coordinates>${last.lng},${last.lat},0</coordinates></Point>` +
          `</Placemark>`
        );
      }
    }

    kmlParts.push(`</Document></kml>`);
    const kml = kmlParts.join("");

    const zip = new JSZip();
    zip.file("doc.kml", kml);
    const blob = await zip.generateAsync({ type: "blob" });

    const a = document.createElement("a");
    const ts = new Date().toLocaleString("sv-SE", { timeZone:"America/Lima" }).replace(/[ :]/g,'-');
    a.href = URL.createObjectURL(blob);
    a.download = `recorridos_cicsa_dia_${ts}.kmz`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    setTimeout(()=>URL.revokeObjectURL(a.href), 2000);
  }catch(e){
    console.error("KMZ error:", e);
    alert("Ocurrió un error al generar el KMZ.");
  }
}

function escapeXml(s){
  return String(s||'').replace(/[<>&'"]/g, ch => ({
    '<':'&lt;','>':'&gt;','&':'&amp;',"'" :'&apos;','"':'&quot;'
  }[ch]));
}
</script>
</body>
</html>
