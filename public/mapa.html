<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>CICSA Monitoreo GPS</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<!-- JSZip para generar KMZ -->
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<style>
  html, body { height: 100%; margin: 0; font-family: "Segoe UI", system-ui, -apple-system, Roboto, Arial; background:#0e1b26; }
  #map { height: 100%; width: 100%; }
  /* (Todo tu CSS original igual, no se cambia) */
</style>
</head>
<body>
  <div id="map"></div>

  <!-- (Todo tu HTML original igual: topbar, panel, etc.) -->

  <!-- =================== TODO TU SCRIPT ORIGINAL =================== -->
  <script>
  /* Todo el código original de tu mapa, sin modificar nada */
  /* (desde const API = location.origin; hasta el final del script original) */
  </script>

  <!-- =================== NUEVO BLOQUE: SUPABASE REALTIME =================== -->
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://fcyerlaliiiuutdzinvg.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZjeWVybGFsaWlpdXV0ZHppbnZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwMTMyMzUsImV4cCI6MjA2OTU4OTIzNX0.fgKF7aE7kiUYGpgom34taZw-1PsYJJ1wlwI5urADc6s";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // 1️⃣ Cargar ubicaciones iniciales
    async function loadInitialData() {
      const { data, error } = await supabase
        .from('ubicaciones_brigadas')
        .select('usuario_id, tecnico, brigada, contrata, zona, cargo, latitud, longitud, timestamp')
        .order('timestamp', { ascending: true })
        .limit(50);

      if (error) {
        console.error("Error cargando ubicaciones:", error);
        return;
      }

      console.log("Cargando ubicaciones iniciales:", data);
      data.forEach((r) => {
        ensureLayer({
          id: `u${r.usuario_id}`,
          lat: r.latitud,
          lng: r.longitud,
          ts: r.timestamp,
          meta: {
            display: r.tecnico || r.brigada || `ID ${r.usuario_id}`,
            brigada: r.brigada, zona: r.zona,
            contrata: r.contrata, cargo: r.cargo
          }
        });
      });

      if (typeof applyFilters === 'function') applyFilters();
      if (typeof rescaleAllMarkers === 'function') rescaleAllMarkers();
    }

    // 2️⃣ Escuchar inserciones en tiempo real desde Supabase
    supabase
      .channel('ubicaciones_brigadas_changes')
      .on('postgres_changes', {
        event: 'INSERT',
        schema: 'public',
        table: 'ubicaciones_brigadas'
      }, (payload) => {
        const r = payload.new;
        console.log("Nueva coordenada recibida:", r);
        ensureLayer({
          id: `u${r.usuario_id}`,
          lat: r.latitud,
          lng: r.longitud,
          ts: r.timestamp,
          meta: {
            display: r.tecnico || r.brigada || `ID ${r.usuario_id}`,
            brigada: r.brigada, zona: r.zona,
            contrata: r.contrata, cargo: r.cargo
          }
        });
        if (typeof applyFilters === 'function') applyFilters();
      })
      .subscribe();

    loadInitialData();
  </script>
</body>
</html>
