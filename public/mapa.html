<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>CICSA Monitoreo GPS</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<style>
  html,body,#map{height:100%;margin:0}
  .topbar{
    position:fixed; inset:10px 10px auto 10px; z-index:1000;
    display:flex; gap:10px; align-items:center;
    background:rgba(15,32,45,.92); color:#fff; padding:10px 14px;
    border-radius:10px; box-shadow:0 8px 24px rgba(0,0,0,.25);
    backdrop-filter: blur(6px);
  }
  .brand{display:flex; align-items:center; gap:10px; padding-right:10px; border-right:1px solid rgba(255,255,255,.12)}
  .brand img{height:28px; object-fit:contain}
  .sel{appearance:none; background:#0f2433; color:#fff; border:1px solid rgba(255,255,255,.15);
       border-radius:8px; padding:6px 10px; outline:none}
  .btn{
    background:#2ecc71; color:#082026; border:none; border-radius:10px; padding:7px 12px;
    font-weight:700; cursor:pointer; box-shadow:0 6px 16px rgba(46,204,113,.35)
  }
  .btn:active{transform:translateY(1px)}
  /* Panel brigadas */
  .panel{
    position:fixed; right:10px; top:72px; width:360px; max-width:92vw; z-index:1000;
    background:rgba(15,32,45,.95); color:#ecf6ff; border-radius:14px; padding:10px 12px;
    box-shadow:0 10px 30px rgba(0,0,0,.3)
  }
  .panel h3{margin:6px 6px 8px; font-size:16px; display:flex; align-items:center; gap:8px}
  .dot{width:9px; height:9px; border-radius:50%; background:#2ecc71; display:inline-block; box-shadow:0 0 0 4px rgba(46,204,113,.15)}
  .card{
    background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08);
    padding:10px 12px; border-radius:12px; margin:8px 4px; cursor:pointer
  }
  .card:hover{background:rgba(255,255,255,.07)}
  .name{font-weight:800}
  .muted{opacity:.8; font-size:12px}
  /* Car icon pulse */
  .car-pulse{
    filter: drop-shadow(0 2px 3px rgba(0,0,0,.35));
    transition: transform .35s ease;    /* animación de posición/rotación */
  }
  /* Línea de ruta */
  .route{
    filter: drop-shadow(0 0 2px rgba(0,0,0,.4));
  }
  .leaflet-popup-content-wrapper{border-radius:10px}
</style>
</head>
<body>
<div id="map"></div>

<!-- Top bar -->
<div class="topbar">
  <div class="brand">
    <img src="/static/logo_cicsa.png" alt="CICSA Logo" onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/4/47/Blue_square.png'">
    <strong>CICSA Monitoreo GPS</strong>
  </div>
  <label>Zona:</label>
  <select id="fZona" class="sel">
    <option value="*">Todas</option><option>NORTE</option><option>SUR</option><option>CENTRO</option><option>LIMA</option>
  </select>
  <label>Contrata:</label>
  <select id="fContrata" class="sel">
    <option value="*">Todas</option><option>CICSA</option><option>SAFESA</option><option>COMATEL</option><option>DOLAN</option><option>ECYTEL</option>
  </select>
  <label>Brigada:</label>
  <select id="fBrigada" class="sel">
    <option value="*">Todas</option>
  </select>
  <button id="btnCenter" class="btn">Centrar</button>
</div>

<!-- Panel brigadas conectadas -->
<div class="panel">
  <h3><span class="dot"></span> Brigadas conectadas</h3>
  <div id="cards"></div>
  <div class="muted" style="margin:6px 6px 0">Consejo: “Centrar” ajusta la vista a los que cumplan los filtros.</div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
/* ================== CONFIG ================== */
const WS_URL = (location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws';
const STALE_MS = 25_000;          // tiempo para ocultar un usuario inactivo
const ROUTE_COLOR = '#0a3a74';    // azul oscuro
const CAR_ICON_URL = 'https://cdn-icons-png.flaticon.com/512/3468/3468377.png'; // carrito
/* ============================================ */

/* ====== MAPA ====== */
const map = L.map('map', { zoomControl:true, minZoom: 4 }).setView([-12.05, -77.05], 12);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
  attribution:'&copy; OpenStreetMap contributors'
}).addTo(map);

/* ====== ICONO CARRO ====== */
const CarIcon = L.icon({
  iconUrl: CAR_ICON_URL,
  iconSize:   [38, 22],
  iconAnchor: [19, 11],   // centro para rotación visual
  popupAnchor:[0, -10],
  className: 'car-pulse'
});

/* ====== ESTADO ====== */
// entidades por usuario_id
const ents = new Map(); // value: {marker, poly, lastTs, meta, lastLatLng}

/* ====== UI ====== */
const fZona = document.getElementById('fZona');
const fContrata = document.getElementById('fContrata');
const fBrigada = document.getElementById('fBrigada');
const cards = document.getElementById('cards');

function cumpleFiltros(meta){
  const zOK = fZona.value==='*' || (meta.zona||'').toUpperCase()===fZona.value;
  const cOK = fContrata.value==='*' || (meta.contrata||'').toUpperCase()===fContrata.value;
  const bOK = fBrigada.value==='*' || (meta.brigada||'').toUpperCase()===fBrigada.value;
  return zOK && cOK && bOK;
}
function aplicarFiltros(){
  ents.forEach((e, uid)=>{
    const ok = cumpleFiltros(e.meta);
    if (ok){
      if (!map.hasLayer(e.marker)) e.marker.addTo(map);
      if (!map.hasLayer(e.poly))   e.poly.addTo(map);
    } else {
      try{ e.marker.remove(); }catch(_){}
      try{ e.poly.remove(); }catch(_){}
    }
  });
  renderCards();
}
[fZona,fContrata,fBrigada].forEach(el=>el.addEventListener('change', aplicarFiltros));

function ensureOptionBrigada(valor){
  if (!valor) return;
  const v = String(valor).toUpperCase();
  const exists = Array.from(fBrigada.options).some(o=>o.value===v);
  if (!exists){
    const opt = document.createElement('option');
    opt.value=v; opt.textContent=v; fBrigada.appendChild(opt);
  }
}

/* ====== TARJETAS ====== */
function renderCards(){
  cards.innerHTML='';
  const list = [...ents.values()]
      .filter(e=>cumpleFiltros(e.meta))
      .sort((a,b)=> (b.lastTs||0)-(a.lastTs||0)); // recientes arriba

  for (const e of list){
    const secs = Math.max(0, Math.round((Date.now()-e.lastTs)/1000));
    const div = document.createElement('div');
    div.className='card';
    div.innerHTML = `
      <div class="name">${(e.meta.nombre||e.meta.tecnico||'').toUpperCase()}</div>
      <div class="muted">${(e.meta.cargo||'').toUpperCase()} • ${(e.meta.contrata||'').toUpperCase()}</div>
      <div class="muted">${(e.meta.zona||'').toUpperCase()} | ${(e.meta.brigada||'').toUpperCase()}</div>
      <div class="muted">Último: hace ${secs}s</div>
    `;
    div.onclick = ()=>{
      if(e.marker && e.marker.getLatLng) {
        map.panTo(e.marker.getLatLng(), {animate:true, duration:.5});
        e.marker.openPopup();
      }
    };
    cards.appendChild(div);
  }
}

/* ====== UTIL ====== */
function bearing(latlng1, latlng2){
  // rumbo en grados [0..360)
  const toRad = d=>d*Math.PI/180, toDeg = r=>r*180/Math.PI;
  const φ1=toRad(latlng1.lat), φ2=toRad(latlng2.lat);
  const Δλ=toRad(latlng2.lng-latlng1.lng);
  const y=Math.sin(Δλ)*Math.cos(φ2);
  const x=Math.cos(φ1)*Math.sin(φ2)-Math.sin(φ1)*Math.cos(φ2)*Math.cos(Δλ);
  return (toDeg(Math.atan2(y,x))+360)%360;
}

function moveSmooth(marker, target, ms=350){
  const start = marker.getLatLng();
  const t0 = performance.now();
  function step(t){
    const k = Math.min(1, (t-t0)/ms);
    const lat = start.lat + (target.lat-start.lat)*k;
    const lng = start.lng + (target.lng-start.lng)*k;
    marker.setLatLng([lat,lng]);
    if (k<1) requestAnimationFrame(step);
  }
  requestAnimationFrame(step);
}

/* ====== NUEVA POSICIÓN ====== */
function nuevaPosicion(p){
  // p: {usuario_id, lat, lng, tecnico/nombre, cargo, zona, contrata, brigada, timestamp}
  const uid = p.usuario_id ?? p.uid ?? p.id;
  if (!uid) return;

  let e = ents.get(uid);
  const latlng = L.latLng(p.lat, p.lng);

  if (!e){
    const poly = L.polyline([latlng], {color:ROUTE_COLOR, weight:4, opacity:0.85, className:'route'});
    const m = L.marker(latlng, {icon:CarIcon, rotationAngle:0}); // rotación visual con transform
    m.bindPopup(`<b>${(p.nombre||p.tecnico||'').toUpperCase()}</b><br>${(p.cargo||'').toUpperCase()} • ${(p.contrata||'').toUpperCase()}<br>${(p.zona||'').toUpperCase()} | ${(p.brigada||'').toUpperCase()}`);

    e = { marker:m, poly, lastTs:Date.now(), meta:{
      nombre:p.nombre, tecnico:p.tecnico, cargo:p.cargo, zona:p.zona, contrata:p.contrata, brigada:p.brigada
    }, lastLatLng:latlng };

    ensureOptionBrigada(p.brigada);
    ents.set(uid, e);

    if (cumpleFiltros(e.meta)){
      poly.addTo(map); m.addTo(map);
    }
  }else{
    // rotación según rumbo
    const dir = bearing(e.lastLatLng, latlng);
    const el = e.marker.getElement();
    if (el){
      el.style.transform = `rotate(${dir}deg)`;
    }
    // animación suave y agrega punto a la ruta
    moveSmooth(e.marker, latlng, 350);
    e.poly.addLatLng(latlng);
    e.lastLatLng = latlng;
    e.lastTs = Date.now();

    // si estaba filtrado, asegúrate de que su capa esté visible/oculta según corresponda
    if (cumpleFiltros(e.meta)){
      if (!map.hasLayer(e.marker)) e.marker.addTo(map);
      if (!map.hasLayer(e.poly))   e.poly.addTo(map);
    }else{
      try{e.marker.remove();}catch(_){}
      try{e.poly.remove();}catch(_){}
    }
  }
  renderCards();
}

/* ====== CENTRAR ====== */
document.getElementById('btnCenter').onclick = ()=>{
  const visibles = [];
  ents.forEach(e=>{
    if (map.hasLayer(e.marker)) visibles.push(e.marker.getLatLng());
  });
  if (visibles.length){
    const b = L.latLngBounds(visibles);
    map.fitBounds(b.pad(0.25));
  }
};

/* ====== AUTOLIMPIEZA DE INACTIVOS ====== */
setInterval(()=>{
  const now = Date.now();
  let changed = false;
  ents.forEach((e, uid)=>{
    if (now - (e.lastTs||0) > STALE_MS){
      try{ e.marker.remove(); }catch(_){}
      try{ e.poly.remove(); }catch(_){}
      ents.delete(uid);
      changed = true;
    }
  });
  if (changed) renderCards();
}, 5000);

/* ====== WS ====== */
(function connectWS(){
  try{
    const ws = new WebSocket(WS_URL);
    ws.onopen   = ()=>console.log('WS conectado');
    ws.onclose  = ()=>{ console.warn('WS cerrado, reintentando…'); setTimeout(connectWS, 3000); };
    ws.onerror  = ()=>{};
    ws.onmessage= (ev)=>{
      try{
        const data = JSON.parse(ev.data);
        // Acepta: objeto único o array de puntos
        const arr = Array.isArray(data) ? data : [data];
        for (const p of arr) nuevaPosicion(p);
      }catch(e){/* ignora */ }
    };
  }catch(e){ console.error(e); setTimeout(connectWS, 5000); }
})();

/* ====== (OPCIONAL) precarga “recientes” si existe endpoint ====== */
(async function preload(){
  try{
    const res = await fetch('/api/recientes');
    if(!res.ok) return; 
    const arr = await res.json();
    if (Array.isArray(arr)){
      arr.forEach(nuevaPosicion);
    }
  }catch(_e){}
})();
</script>
</body>
</html>
