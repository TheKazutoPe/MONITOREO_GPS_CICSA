<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Viewer | Monitoreo GPS</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    :root{color-scheme:dark}
    body{margin:0;background:#0b1220;color:#e5e7eb;font-family:system-ui,Segoe UI,Roboto}
    header{display:flex;gap:12px;align-items:center;padding:12px 16px;border-bottom:1px solid #1f2937;background:#0b1220;position:sticky;top:0}
    .pill{padding:4px 8px;border-radius:999px;font-size:12px;border:1px solid #374151}
    .ok{color:#22c55e;border-color:#22c55e}
    .bad{color:#f87171;border-color:#f87171}
    #map{height:calc(100svh - 56px)}
    #warn{color:#fca5a5;padding:8px 12px}
  </style>
</head>
<body>
  <header>
    <strong>Viewer</strong>
    <span id="wsState" class="pill bad">WS: desconectado</span>
    <a class="pill" href="/login.html" style="text-decoration:none">Login</a>
  </header>
  <div id="warn"></div>
  <div id="map"></div>

  <script src="/env.js"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
  (async () => {
    const warn = document.getElementById('warn');
    const wsState = document.getElementById('wsState');

    if (!window.ENV?.SUPABASE_URL || !window.ENV?.SUPABASE_ANON_KEY) {
      warn.textContent = "Faltan variables (env.js)."; return;
    }
    const supabase = window.supabase.createClient(ENV.SUPABASE_URL, ENV.SUPABASE_ANON_KEY);

    // requiere sesión para abrir WS
    const { data: { session } } = await supabase.auth.getSession();
    if (!session?.access_token) { warn.textContent = "Primero inicia sesión."; return; }

    // mapa
    const map = L.map('map').setView([-12.0464, -77.0428], 12);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19 }).addTo(map);

    const carIcon = L.icon({ iconUrl: '/img/car.svg', iconSize:[28,14], iconAnchor:[14,7] });

    // Marcadores por user_id
    const markers = new Map();

    const wsUrl = (location.protocol === "https:" ? "wss://" : "ws://") + location.host + "/ws?token=" + encodeURIComponent(session.access_token);
    const ws = new WebSocket(wsUrl);

    ws.addEventListener("open", () => { wsState.classList.remove('bad'); wsState.classList.add('ok'); wsState.textContent = "WS: conectado"; });
    ws.addEventListener("close", () => { wsState.classList.remove('ok'); wsState.classList.add('bad'); wsState.textContent = "WS: desconectado"; });

    function upsertMarker(u) {
      const key = u.user_id || u.id;
      let mk = markers.get(key);
      if (!mk) {
        mk = L.marker([u.lat,u.lng], { icon: carIcon }).addTo(map);
        markers.set(key, mk);
      } else {
        mk.setLatLng([u.lat,u.lng]);
      }
      // Tooltip con el id/brigada si la tienes en tu snapshot
      mk.bindTooltip(u.brigada ? u.brigada : (key ?? 'brigada'), { permanent:false });
    }

    ws.addEventListener('message', (ev) => {
      try {
        const msg = JSON.parse(ev.data);
        if (msg.type === "snapshot") {
          const entries = Object.values(msg.data || {});
          entries.forEach(upsertMarker);
          if (entries.length) map.setView([entries[0].lat, entries[0].lng], 14);
        }
        if (msg.type === "point") upsertMarker(msg.data);
      } catch {}
    });
  })();
  </script>
</body>
</html>
