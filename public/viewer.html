<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Monitoreo de Brigadas</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<style>
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif;background:#0b1220;color:#e6edf6}
  #map{position:fixed;inset:0 320px 0 0}
  aside{position:fixed;right:0;top:0;bottom:0;width:320px;background:#0f172a;border-left:1px solid #1f2937;overflow:auto}
  header{padding:10px 12px;border-bottom:1px solid #1f2937}
  .item{padding:10px 12px;border-bottom:1px solid #111827;cursor:pointer}
  .item:hover{background:#111827}
  .small{color:#93a3b8;font-size:.85rem}
  .row{display:flex;justify-content:space-between;align-items:center}
  .pill{padding:2px 8px;border:1px solid #334155;border-radius:999px;font-size:.75rem}
  .ok{color:#22c55e;border-color:#14532d}
</style>
</head>
<body>
<div id="map"></div>
<aside>
  <header>
    <strong>Brigadas (hoy)</strong>
    <div class="small">Click para enfocar</div>
  </header>
  <div id="list"></div>
</aside>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const SUPABASE_URL = "{{SUPABASE_URL}}";
const SUPABASE_ANON_KEY = "{{SUPABASE_ANON_KEY}}";
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const map = L.map('map').setView([-12.05,-77.05], 12);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);

const markers = new Map();   // user_id -> marker
const polylines = new Map(); // track_id -> polyline
let token;

(async ()=>{
  const { data } = await supa.auth.getSession();
  if (!data.session) return location.href='/login.html';
  token = data.session.access_token;
  loadActiveToday();
  connectWS();
})();

async function loadActiveToday(){
  const r = await fetch('/api/active-today', { headers: { Authorization: 'Bearer '+token }});
  const { tracks=[] } = await r.json();
  const panel = document.getElementById('list');
  panel.innerHTML = '';
  tracks.forEach(t=>{
    const br = t.technicians?.brigada || 'â€”';
    const li = document.createElement('div');
    li.className='item';
    li.innerHTML = `
      <div class="row"><div><b>${br}</b></div>
        <div class="pill ok">online</div></div>
      <div class="small">${t.technicians?.username || t.user_id}</div>`;
    li.onclick = ()=> focusTrack(t.id);
    panel.appendChild(li);
    // precargar trazo
    fetch(`/api/track/${t.id}`, { headers:{Authorization:'Bearer '+token}}).then(r=>r.json()).then(({positions=[]})=>{
      if (!positions.length) return;
      const coords = positions.map(p=>[p.lat, p.lng]);
      const pl = L.polyline(coords, {weight:4}).addTo(map);
      polylines.set(t.id, pl);
      const mk = L.marker(coords.at(-1)).addTo(map).bindPopup(br);
      markers.set(t.user_id, mk);
    });
  });
}

function focusTrack(trackId){
  const pl = polylines.get(trackId);
  if (pl) map.fitBounds(pl.getBounds().pad(0.2));
}

function connectWS(){
  const ws = new WebSocket(`${location.protocol==='https:'?'wss':'ws'}://${location.host}/ws?token=${token}`);
  ws.onmessage = (e)=>{
    const m = JSON.parse(e.data||'{}');
    if (m.type==='snapshot'){
      for (const [uid,p] of Object.entries(m.data||{})) {
        upsertPoint(uid, p.lat, p.lng);
      }
    }
    if (m.type==='point'){
      const { user_id, track_id, lat, lng } = m.data;
      upsertPoint(user_id, lat, lng);
      let pl = polylines.get(track_id);
      if (!pl){ pl = L.polyline([], {weight:4}).addTo(map); polylines.set(track_id, pl); }
      pl.addLatLng([lat,lng]);
    }
  };
}

function upsertPoint(uid, lat, lng){
  let mk = markers.get(uid);
  if (!mk) { mk = L.marker([lat,lng]).addTo(map); markers.set(uid,mk); }
  else mk.setLatLng([lat,lng]);
}
</script>
</body>
</html>
