<!doctype html>
<meta charset="utf-8" />
<title>Viewer</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<div id="map" style="height:100vh"></div>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const SUPABASE_URL = "https://fcyerlaliiiuutdzinvg.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZjeWVybGFsaWlpdXV0ZHppbnZnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQwMTMyMzUsImV4cCI6MjA2OTU4OTIzNX0.fgKF7aE7kiUYGpgom34taZw-1PsYJJ1wlwI5urADc6s";
const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
let token;
(async ()=>{
  const { data } = await supa.auth.getSession();
  if (!data.session) return location.href="/login.html";
  token = data.session.access_token;
  startWS();
})();

const map = L.map('map').setView([-12.05,-77.05], 12);
L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(map);
const markers = new Map();

function upsert(uid, lat, lng) {
  let mk = markers.get(uid);
  if (!mk) {
    mk = L.marker([lat,lng]).addTo(map).bindPopup(uid);
    markers.set(uid, mk);
  } else mk.setLatLng([lat,lng]);
}

function fit() {
  const arr = [...markers.values()];
  if (!arr.length) return;
  const bounds = L.latLngBounds(arr.map(m => m.getLatLng()));
  map.fitBounds(bounds.pad(0.2));
}

function startWS(){
  const ws = new WebSocket(`${location.protocol==='https:'?'wss':'ws'}://${location.host}/ws?token=${token}`);
  ws.onmessage = (e)=>{
    const m = JSON.parse(e.data);
    if (m.type === 'snapshot') {
      for (const [uid, p] of Object.entries(m.data || {})) upsert(uid, p.lat, p.lng);
      fit();
    }
    if (m.type === 'point') {
      const { user_id, lat, lng } = m.data || {};
      if (lat==null || lng==null) return;
      upsert(user_id, lat, lng);
    }
  };
}
</script>
