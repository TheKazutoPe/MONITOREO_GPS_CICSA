<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Monitoreo GPS CICSA</title>
<style>
  body {
    background: radial-gradient(circle at center, #001a2b, #000c14);
    color: #fff;
    height: 100vh; display:flex; justify-content:center; align-items:center;
    font-family: "Segoe UI", sans-serif;
  }
  .card{background:rgba(10,30,50,.92);border-radius:14px;padding:25px;width:350px;text-align:center;
        box-shadow:0 0 20px rgba(0,255,200,.4);transition:.3s;}
  .card.glow{box-shadow:0 0 25px rgba(0,255,200,.8)}
  .card h2{margin:10px 0 2px}
  .card small{color:#a8d6ff}
  .row{display:flex; gap:8px; margin:8px 0;}
  input{
    flex:1; padding:10px 12px; border-radius:10px; border:1px solid #0a2a3f;
    background:#06121c; color:#dff1ff; outline:none;
  }
  button{
    background:#0aa6a6; border:none; color:#002b36; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:600;
  }
  button:disabled{ opacity:.6; }
  .danger{ background:#da3d5b; color:#fff; }
  .info{ font-size:13px; color:#bfe9ff; display:none; margin-top:8px }
  .error{ color:#ffb3c1; height:18px; margin-top:6px; }
</style>
</head>
<body>
  <div class="card" id="panel">
    <h2>Monitoreo GPS</h2>
    <small>CICSA ‚Ä¢ Tiempo real</small>

    <div class="row">
      <input id="txtUser" placeholder="Usuario" />
    </div>
    <div class="row">
      <input id="txtPass" placeholder="Clave" type="password" />
    </div>
    <div class="row">
      <button id="btnStart">Iniciar transmisi√≥n</button>
      <button id="btnStop" class="danger" disabled>Detener</button>
    </div>
    <div class="info" id="info">Enviando posici√≥n cada ~5 segundos‚Ä¶</div>
    <div class="error" id="error"></div>
    <div id="status" style="margin-top:8px;font-size:13px;color:#bde5ff"></div>
  </div>

<script>
const API = location.origin;

const panel = document.getElementById('panel');
const btnStart = document.getElementById('btnStart');
const btnStop  = document.getElementById('btnStop');
const txtUser  = document.getElementById('txtUser');
const txtPass  = document.getElementById('txtPass');
const infoEl   = document.getElementById('info');
const errorEl  = document.getElementById('error');
const statusEl = document.getElementById('status');

let user = null;
let watchId = null;
let lastSend = 0;

async function login(usuario, clave){
  const res = await fetch(`${API}/api/login`,{
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify({usuario, clave})
  });
  const data = await res.json();
  if(!data.ok) throw new Error(data.error || "Login inv√°lido");
  return data.usuario;
}

async function enviarPosicion(data){
  await fetch(`${API}/api/posicion`,{
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify(data)
  });
}

function iniciarGPS(usr){
  user = usr;
  panel.classList.add("glow");
  btnStart.disabled = true;
  btnStop.disabled  = false;
  btnStart.textContent = "Transmitiendo...";
  statusEl.textContent = "üü¢ Transmitiendo posici√≥n en tiempo real...";
  infoEl.style.display = "block";
  errorEl.textContent = "";

  if (!navigator.geolocation){
    errorEl.textContent = "Geolocalizaci√≥n no soportada en este navegador.";
    return;
  }

  const opts = { enableHighAccuracy:true, maximumAge:0, timeout:10000 };
  watchId = navigator.geolocation.watchPosition(async (pos)=>{
    const crd = pos.coords;
    const now = Date.now();
    if (now - lastSend < 4500) return; // throttling
    lastSend = now;

    const payload = {
      usuario_id: user.id,
      tecnico: user.tecnico,
      brigada: user.brigada,
      contrata: user.contrata,
      zona: user.zona,
      cargo: user.cargo,
      lat: crd.latitude,
      lng: crd.longitude
    };
    try{
      await enviarPosicion(payload);
    }catch(e){
      console.error(e);
      errorEl.textContent = "No se pudo enviar posici√≥n.";
    }
  }, (err)=>{
    errorEl.textContent = "No se puede obtener tu ubicaci√≥n (" + err.message + ")";
  }, opts);
}

function detenerGPSUI(){
  panel.classList.remove("glow");
  btnStart.disabled = false;
  btnStop.disabled  = true;
  btnStart.textContent = "Iniciar transmisi√≥n";
  statusEl.textContent = "‚èπÔ∏è Transmisi√≥n detenida.";
  infoEl.style.display = "none";
}

btnStart.onclick = async ()=>{
  try{
    const u = await login(txtUser.value.trim(), txtPass.value.trim());
    iniciarGPS(u);
  }catch(e){
    errorEl.textContent = e.message;
  }
};

btnStop.onclick = async ()=>{
  if (watchId != null){
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
  }
  // intento opcional (no rompe si el endpoint no existe)
  try{
    if (user?.id) {
      await fetch(`${API}/api/stop`,{
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ usuario_id: user.id })
      });
    }
  }catch(_e){}
  detenerGPSUI();
};
</script>
</body>
</html>
