<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Monitoreo GPS CICSA</title>
<style>
  body {
    background: radial-gradient(circle at center, #001a2b, #000c14);
    color: #fff;
    height: 100vh; display:flex; justify-content:center; align-items:center;
    font-family: "Segoe UI", sans-serif;
  }
  .card{background:rgba(10,30,50,.92);border-radius:14px;padding:25px;width:350px;text-align:center;
        box-shadow:0 0 20px rgba(0,255,200,.4);transition:.3s;}
  .card.glow{box-shadow:0 0 25px rgba(0,255,200,.8)}
  .logo{height:60px;margin-bottom:10px}
  input{width:90%;padding:8px;margin:6px 0;border:none;border-radius:6px;text-align:center}
  button{background:#00b050;color:#fff;border:none;border-radius:6px;padding:10px 15px;cursor:pointer;
         margin-top:8px;width:95%;font-weight:600}
  button:hover{background:#009944}
  #btnStop{background:#d9534f} #btnStop:hover{background:#c83f3b}
  #status{margin-top:12px;font-size:14px;color:#00e676}
  #info{background:rgba(0,0,0,.25);border-radius:8px;margin-top:10px;text-align:left;padding:8px 12px;
        font-size:13px;display:none}
  .error{color:#ff6666;font-size:14px}
</style>
</head>
<body>
  <div class="card" id="panel">
    <img src="/static/logo_cicsa.png" alt="CICSA" class="logo" />
    <h2>Monitoreo GPS</h2>
    <p>Ingreso para técnicos / brigadas</p>

    <input id="usuario" placeholder="Usuario" />
    <input id="clave" type="password" placeholder="Clave" />

    <button id="btnStart">Iniciar transmisión GPS</button>
    <button id="btnStop" disabled>Detener transmisión</button>

    <div id="status"></div>
    <div id="info"></div>
    <div id="error" class="error"></div>
  </div>

<script>
const API = "https://monitoreo-gps-cicsa.onrender.com"; // Render
const btnStart = document.getElementById("btnStart");
const btnStop  = document.getElementById("btnStop");
const statusEl = document.getElementById("status");
const infoEl   = document.getElementById("info");
const errorEl  = document.getElementById("error");
const panel    = document.getElementById("panel");

let user = null;
let watchId = null;
let lastSend = 0;

async function login(usuario, clave){
  const res = await fetch(`${API}/api/login`,{
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify({usuario, clave})
  });
  const data = await res.json();
  if(!data.ok) throw new Error(data.error || "Login inválido");
  return data.usuario;
}

async function enviarPosicion(data){
  await fetch(`${API}/api/posicion`,{
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify(data)
  });
}

function iniciarGPS(usr){
  user = usr;
  panel.classList.add("glow");
  btnStart.disabled = true;
  btnStop.disabled  = false;
  btnStart.textContent = "Transmitiendo...";
  statusEl.textContent = "🟢 Transmitiendo posición en tiempo real...";
  infoEl.style.display = "block";
  errorEl.textContent = "";

  if(!navigator.geolocation){
    statusEl.textContent = "⚠️ Geolocalización no soportada.";
    return;
  }

  // Limpia un watcher previo si lo hubiera
  if (watchId !== null) {
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
  }

  watchId = navigator.geolocation.watchPosition(async pos=>{
    const {latitude, longitude, accuracy, speed} = pos.coords;
    const ahora = Date.now();
    if (ahora - lastSend < 5000) return; // 5s debounce
    lastSend = ahora;

    const payload = {
      usuario_id: user.id,
      tecnico: user.nombre,
      brigada: user.brigada,
      contrata: user.contrata,
      zona: user.zona,
      cargo: user.cargo,
      lat: latitude,
      lng: longitude
    };

    infoEl.innerHTML = `
      <b>Coordenadas:</b> ${latitude.toFixed(5)}, ${longitude.toFixed(5)}<br>
      <b>Precisión:</b> ${accuracy?.toFixed?.(1) ?? "-"} m<br>
      <b>Velocidad:</b> ${(speed || 0).toFixed(1)} km/h<br>
      <b>Hora local:</b> ${new Date().toLocaleTimeString()}
    `;
    try { await enviarPosicion(payload); } catch(e){}
  }, err=>{
    statusEl.textContent = "⚠️ Error obteniendo posición.";
    console.error(err);
  }, { enableHighAccuracy:true, maximumAge:0, timeout:20000 });
}

function detenerGPSUI(){
  panel.classList.remove("glow");
  btnStart.disabled = false;
  btnStop.disabled  = true;
  btnStart.textContent = "Iniciar transmisión GPS";
  statusEl.textContent = "🔴 Transmisión detenida.";
}

btnStart.onclick = async ()=>{
  const u = document.getElementById("usuario").value.trim();
  const p = document.getElementById("clave").value.trim();
  if(!u || !p){ errorEl.textContent = "Ingrese usuario y clave"; return; }
  errorEl.textContent = "";
  try{
    const usr = await login(u,p);
    iniciarGPS(usr);
  }catch(e){ errorEl.textContent = e.message; }
};

btnStop.onclick = async ()=>{
  // corta el watcher local
  if (watchId !== null) {
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
  }
  // intento opcional (no rompe si el endpoint no existe)
  try{
    if (user?.id) {
      await fetch(`${API}/api/stop`,{
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ usuario_id: user.id })
      });
    }
  }catch(_e){}
  detenerGPSUI();
};
</script>
</body>
</html>
