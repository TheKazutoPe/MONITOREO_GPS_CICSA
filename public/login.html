<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ingresar | Monitoreo GPS</title>
  <style>
    :root{color-scheme:dark light}
    body{margin:0;min-height:100svh;display:grid;place-items:center;background:#0b1220;color:#e6edf6;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif}
    .card{width:min(420px,92vw);background:#0f172a;border:1px solid #1f2937;border-radius:16px;padding:22px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h1{margin:0 0 6px;font-size:1.25rem}
    p.muted{margin:0 0 18px;color:#93a3b8;font-size:.9rem}
    label{display:block;margin:10px 0 6px;color:#93a3b8;font-size:.85rem}
    input{width:100%;padding:12px;border-radius:12px;border:1px solid #334155;background:#0b1220;color:#e6edf6}
    .row{display:flex;justify-content:space-between;align-items:center;margin:10px 0}
    .checkbox{display:flex;gap:8px;align-items:center;color:#cbd5e1;font-size:.9rem}
    button.primary{width:100%;padding:13px;border:none;border-radius:12px;background:#2563eb;color:#fff;font-weight:700;font-size:1rem;cursor:pointer}
    button.primary[disabled]{opacity:.6;cursor:not-allowed}
    .links{display:flex;gap:10px;justify-content:space-between;margin-top:12px}
    a{color:#60a5fa;text-decoration:none}
    .msg{margin-top:10px;min-height:1.2em;font-size:.9rem}
    .err{color:#f87171}.ok{color:#34d399}
  </style>
</head>
<body>
  <div class="card">
    <h1>Monitoreo GPS</h1>
    <p class="muted">Ingresa con tu correo</p>

    <label for="email">Correo</label>
    <input id="email" type="email" placeholder="tecnico@empresa.com" autocomplete="username" />

    <label for="password">Contraseña</label>
    <input id="password" type="password" placeholder="********" autocomplete="current-password" />

    <div class="row">
      <label class="checkbox"><input id="remember" type="checkbox" checked /> Mantener sesión</label>
      <a href="#" id="reset">¿Olvidaste tu contraseña?</a>
    </div>

    <button id="login" class="primary">Ingresar</button>
    <div id="msg" class="msg"></div>

    <div class="links">
      <a href="/viewer.html">Ir al viewer</a>
      <a href="/admin.html">Panel supervisor</a>
    </div>
  </div>

  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      const SUPABASE_URL = "{{SUPABASE_URL}}";
      const SUPABASE_ANON_KEY = "{{SUPABASE_ANON_KEY}}";
      const email = document.getElementById('email');
      const password = document.getElementById('password');
      const remember = document.getElementById('remember');
      const loginBtn = document.getElementById('login');
      const msg = document.getElementById('msg');
      const reset = document.getElementById('reset');

      // Guard por si no se inyectaron las envs
      if (!SUPABASE_URL || !SUPABASE_ANON_KEY ||
          SUPABASE_URL.includes('{{') || SUPABASE_ANON_KEY.includes('{{')) {
        loginBtn.disabled = true;
        msg.className = 'msg err';
        msg.textContent = 'Faltan variables SUPABASE_URL / SUPABASE_ANON_KEY en el servidor.';
        return;
      }

      const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

      try {
        const { data } = await supa.auth.getSession();
        if (data.session) return location.replace('/');
      } catch {}

      function show(text, ok=false){
        msg.className = 'msg ' + (ok ? 'ok':'err');
        msg.textContent = text || '';
      }

      async function doLogin(){
        show('');
        const mail = (email.value || '').trim();
        const pass = password.value || '';
        if (!mail || !pass) return show('Ingresa tu correo y contraseña.');
        try {
          loginBtn.disabled = true;
          loginBtn.textContent = 'Ingresando…';
          const { error } = await supa.auth.signInWithPassword({ email: mail, password: pass });
          if (error) return show(error.message);
          if (!remember.checked) {
            window.addEventListener('beforeunload', () => { supa.auth.signOut(); }, { once:true });
          }
          location.replace('/');
        } catch (e) {
          show('Error de autenticación.');
          console.error(e);
        } finally {
          loginBtn.disabled = false;
          loginBtn.textContent = 'Ingresar';
        }
      }

      async function doReset(e){
        e.preventDefault();
        const mail = (email.value || '').trim();
        if (!mail) return show('Escribe tu correo para enviar el enlace.');
        try {
          const { error } = await supa.auth.resetPasswordForEmail(mail, {
            redirectTo: window.location.origin + '/login.html'
          });
          if (error) return show(error.message);
          show('Te enviamos un enlace para restablecer la contraseña.', true);
        } catch (e) {
          console.error(e);
          show('No se pudo enviar el correo.');
        }
      }

      loginBtn.addEventListener('click', doLogin);
      password.addEventListener('keydown', (ev)=>{ if(ev.key==='Enter') doLogin(); });
      reset.addEventListener('click', doReset);
    });
  </script>
</body>
</html>
