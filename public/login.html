<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Ingresar | Monitoreo GPS</title>
<style>
  :root { color-scheme: dark light; }
  body{margin:0;min-height:100svh;display:grid;place-items:center;background:#0b1220;color:#e6edf6;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,sans-serif}
  .card{width:min(420px,92vw);background:#0f172a;border:1px solid #1f2937;border-radius:16px;padding:22px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  h1{margin:0 0 6px;font-size:1.25rem}
  p.muted{margin:0 0 18px;color:#93a3b8;font-size:.9rem}
  label{display:block;margin:10px 0 6px;color:#93a3b8;font-size:.85rem}
  input{width:100%;padding:12px;border-radius:12px;border:1px solid #334155;background:#0b1220;color:#e6edf6}
  .row{display:flex;justify-content:space-between;align-items:center;margin:10px 0}
  .checkbox{display:flex;gap:8px;align-items:center;color:#cbd5e1;font-size:.9rem}
  button.primary{width:100%;padding:13px;border:none;border-radius:12px;background:#2563eb;color:#fff;font-weight:700;font-size:1rem}
  .links{display:flex;gap:10px;justify-content:space-between;margin-top:12px}
  a{color:#60a5fa;text-decoration:none}
  .err{margin-top:10px;color:#f87171;font-size:.9rem;min-height:1.2em}
  .ok{color:#34d399}
</style>
</head>
<body>
  <div class="card">
    <h1>Monitoreo GPS</h1>
    <p class="muted">Ingresa con tu correo corporativo</p>

    <label>Correo</label>
    <input id="email" type="email" placeholder="tecnico@empresa.com" autocomplete="username" />

    <label>Contraseña</label>
    <input id="password" type="password" placeholder="********" autocomplete="current-password" />

    <div class="row">
      <label class="checkbox"><input id="remember" type="checkbox" checked /> Mantener sesión</label>
      <a href="#" id="reset">¿Olvidaste tu contraseña?</a>
    </div>

    <button id="login" class="primary">Ingresar</button>
    <div id="msg" class="err"></div>

    <div class="links">
      <a href="/viewer.html">Ir al viewer</a>
      <a href="/admin.html">Panel supervisor</a>
    </div>
  </div>

<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
<script>
  // Reemplaza por tus variables (o inyecta en build)
  const SUPABASE_URL = "{{SUPABASE_URL}}";
  const SUPABASE_ANON_KEY = "{{SUPABASE_ANON_KEY}}";

  const supa = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  // Si ya hay sesión, directo al emisor
  supa.auth.getSession().then(({data})=>{
    if (data.session) location.replace('/');
  });

  const email = document.getElementById('email');
  const password = document.getElementById('password');
  const remember = document.getElementById('remember');
  const msg = document.getElementById('msg');

  document.getElementById('login').onclick = async ()=>{
    msg.textContent = '';
    if (!email.value || !password.value) {
      msg.textContent = 'Ingresa correo y contraseña.';
      return;
    }
    try{
      const { data, error } = await supa.auth.signInWithPassword({
        email: email.value.trim(),
        password: password.value,
        options: { captchaToken: undefined }
      });
      if (error) { msg.textContent = error.message; return; }

      // Persistencia de sesión
      await supa.auth.setSession(data.session);
      if (!remember.checked) {
        // si no quiere mantener sesión, nos deslogueamos al cerrar la pestaña
        window.addEventListener('beforeunload', ()=> supa.auth.signOut(), { once:true });
      }
      location.replace('/');
    }catch(e){
      msg.textContent = 'Error al iniciar sesión';
    }
  };

  // Reset por correo (usa plantilla de Supabase > Auth > Email Templates)
  document.getElementById('reset').onclick = async (e)=>{
    e.preventDefault();
    msg.className='err';
    msg.textContent = '';
    if (!email.value) { msg.textContent = 'Escribe tu correo para enviar el enlace.'; return; }
    const { error } = await supa.auth.resetPasswordForEmail(email.value.trim(), {
      redirectTo: window.location.origin + '/login.html'
    });
    msg.textContent = error ? error.message : 'Te enviamos un enlace para restablecer la contraseña.';
    if (!error) msg.className = 'ok';
  };
</script>
</body>
</html>
