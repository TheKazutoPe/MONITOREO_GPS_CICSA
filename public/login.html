<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CICSA Monitoreo GPS</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: radial-gradient(circle at center, #001a2b, #000c14);
      color: #fff;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .card {
      background: rgba(10, 30, 50, 0.9);
      border-radius: 15px;
      padding: 30px;
      width: 340px;
      text-align: center;
      box-shadow: 0 0 20px rgba(0,255,200,0.4);
      transition: all .3s;
    }

    .card.glow {
      box-shadow: 0 0 25px rgba(0,255,200,0.8);
    }

    .logo {
      display: block;
      margin: 0 auto 10px;
      height: 40px;
    }

    h2 {
      margin: 10px 0 4px;
      color: #fff;
    }

    input {
      width: 90%;
      padding: 8px;
      margin: 8px 0;
      border: none;
      border-radius: 6px;
      text-align: center;
    }

    button {
      background: #00b050;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 10px 15px;
      cursor: pointer;
      margin-top: 10px;
    }

    button:hover { background: #009944; }

    #status {
      margin-top: 15px;
      font-size: 14px;
      color: #00e676;
    }

    #info {
      background: rgba(0,0,0,0.25);
      border-radius: 8px;
      margin-top: 10px;
      text-align: left;
      padding: 8px 12px;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <div class="card" id="panel">
    <img src="/static/logo_cicsa.png" alt="CICSA" class="logo">
    <h2>Monitoreo GPS</h2>
    <p>Ingreso para t√©cnicos / brigadas</p>

    <input id="usuario" placeholder="Usuario" />
    <input id="clave" type="password" placeholder="Clave" />
    <button id="btnStart">Iniciar transmisi√≥n GPS</button>

    <div id="status"></div>
    <div id="info"></div>
  </div>

  <script>
    const btn = document.getElementById("btnStart");
    const statusEl = document.getElementById("status");
    const infoEl = document.getElementById("info");
    const panel = document.getElementById("panel");

    let watchID = null;
    let sending = false;

    async function enviarPosicion(usuario, lat, lon, precision, velocidad) {
      try {
        const body = {
          usuario,
          latitud: lat,
          longitud: lon,
          precision,
          velocidad,
          timestamp: new Date().toISOString()
        };

        await fetch("/api/ubicaciones", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body)
        });
      } catch (err) {
        console.error("‚ùå Error al enviar posici√≥n:", err);
      }
    }

    function iniciarTransmision() {
      const usuario = document.getElementById("usuario").value.trim();
      if (!usuario) {
        alert("Ingrese su usuario para iniciar.");
        return;
      }

      btn.disabled = true;
      btn.textContent = "Transmitiendo...";
      statusEl.innerHTML = "üü¢ Transmitiendo posici√≥n en tiempo real...";
      panel.classList.add("glow");

      if (!navigator.geolocation) {
        statusEl.innerHTML = "‚ö†Ô∏è Geolocalizaci√≥n no soportada";
        return;
      }

      let ultima = 0;
      watchID = navigator.geolocation.watchPosition(
        async (pos) => {
          const { latitude, longitude, accuracy, speed } = pos.coords;
          const ahora = Date.now();
          if (ahora - ultima < 5000) return; // enviar cada 5s
          ultima = ahora;

          infoEl.innerHTML = `
            <b>Coordenadas:</b> ${latitude.toFixed(5)}, ${longitude.toFixed(5)}<br>
            <b>Precisi√≥n:</b> ${accuracy.toFixed(1)} m<br>
            <b>Velocidad:</b> ${(speed || 0).toFixed(1)} km/h<br>
            <b>Hora local:</b> ${new Date().toLocaleTimeString()}
          `;

          await enviarPosicion(usuario, latitude, longitude, accuracy, (speed || 0) * 3.6);
        },
        (err) => {
          statusEl.innerHTML = "‚ö†Ô∏è Error al obtener ubicaci√≥n";
          console.error(err);
        },
        { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
      );
    }

    btn.onclick = iniciarTransmision;
  </script>
</body>
</html>
