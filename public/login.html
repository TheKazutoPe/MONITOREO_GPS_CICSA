<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CICSA ¬∑ Monitoreo GPS</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background: radial-gradient(circle at top, #001a2b 0%, #000f1b 100%);
      color: #fff;
      font-family: "Segoe UI", sans-serif;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    .card {
      background: rgba(0, 25, 45, 0.95);
      border: 1px solid #00a2ff;
      border-radius: 15px;
      box-shadow: 0 0 25px rgba(0,0,0,0.5);
      width: 360px;
      padding: 25px;
      transition: all .3s ease;
    }

    .card.transmitting {
      border: 2px solid transparent;
      background: linear-gradient(#001a2b,#001a2b) padding-box,
                  linear-gradient(120deg,#00a2ff,#00ffcc) border-box;
      animation: borderGlow 3s linear infinite;
    }

    @keyframes borderGlow {
      0% { filter: drop-shadow(0 0 2px #00a2ff); }
      50% { filter: drop-shadow(0 0 6px #00ffcc); }
      100% { filter: drop-shadow(0 0 2px #00a2ff); }
    }

    .logo img { height: 45px; filter: drop-shadow(0 0 3px #00a2ff); }

    h5, p { color: #e5f4ff !important; }

    .form-label { color: #b8dfff !important; font-weight: 600; }

    input.form-control {
      background: #06253f;
      color: #fff;
      border: 1px solid #0a64a0;
    }

    input.form-control:focus {
      border-color: #00aaff;
      box-shadow: 0 0 5px #00aaff;
    }

    .btn-primary {
      background: linear-gradient(90deg,#0099ff,#00c8b8);
      font-weight: 600;
      text-shadow: 0 1px 2px rgba(0,0,0,0.2);
      border: none;
    }

    .data-block {
      background: rgba(0,0,0,0.4);
      color: #aee6ff;
      border: 1px solid rgba(0,170,255,0.4);
      border-radius: 10px;
      padding: 10px;
    }

    .pulse {
      width: 10px; height: 10px;
      border-radius: 50%;
      background: #00e676;
      display: inline-block;
      margin-right: 6px;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.4); opacity: 0.5; }
      100% { transform: scale(1); opacity: 1; }
    }
  </style>
</head>
<body>
  <div class="card" id="login-card">
    <div class="logo text-center mb-3">
      <img src="/static/logo_cicsa.png" alt="CICSA" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3790/3790033.png'">
      <h5 class="mt-2">Monitoreo GPS</h5>
      <p style="font-size:13px;">Ingreso para t√©cnicos / brigadas</p>
    </div>

    <div id="login-form">
      <div class="mb-3">
        <label class="form-label">Usuario</label>
        <input type="text" id="usuario" class="form-control" placeholder="Ej: apradou" required>
      </div>
      <div class="mb-3">
        <label class="form-label">Clave</label>
        <input type="password" id="clave" class="form-control" placeholder="*******" required>
      </div>
      <button class="btn btn-primary w-100" id="btnStart">Iniciar transmisi√≥n GPS</button>
      <div id="status" class="text-center mt-2 text-info">Esperando conexi√≥n...</div>
    </div>

    <div id="transmitiendo" style="display:none;">
      <h6 class="text-success mb-3"><span class="pulse"></span> Transmitiendo posici√≥n en tiempo real...</h6>
      <div class="data-block" id="gps-info">
        <b>Coordenadas:</b> <span id="coords">--</span><br>
        <b>Precisi√≥n:</b> <span id="accuracy">--</span> m<br>
        <b>Velocidad:</b> <span id="speed">--</span> km/h<br>
        <b>Hora local:</b> <span id="hora">--</span>
      </div>
    </div>
  </div>

  <script>
    const card = document.getElementById("login-card");
    const form = document.getElementById("login-form");
    const transmit = document.getElementById("transmitiendo");
    const statusEl = document.getElementById("status");

    document.getElementById("btnStart").addEventListener("click", async () => {
      const user = document.getElementById("usuario").value.trim();
      const pass = document.getElementById("clave").value.trim();

      if (!user || !pass) return alert("Ingrese usuario y clave");

      form.style.display = "none";
      transmit.style.display = "block";
      card.classList.add("transmitting");
      statusEl.innerHTML = "üîó Conectado al servidor...";
      iniciarGPS(user);
    });

    function iniciarGPS(usuario) {
      if (!navigator.geolocation) {
        statusEl.innerHTML = "‚ö†Ô∏è GPS no disponible en este dispositivo.";
        return;
      }

      function enviar(lat, lon, acc, speed) {
        fetch("/api/ubicaciones", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ usuario, latitud: lat, longitud: lon, precision: acc, velocidad: speed, timestamp: Date.now() })
        }).catch(() => {});
      }

      navigator.geolocation.watchPosition(
        pos => {
          const { latitude, longitude, accuracy, speed } = pos.coords;
          document.getElementById("coords").innerText = `${latitude.toFixed(5)}, ${longitude.toFixed(5)}`;
          document.getElementById("accuracy").innerText = accuracy.toFixed(1);
          document.getElementById("speed").innerText = (speed ? (speed * 3.6).toFixed(1) : 0);
          document.getElementById("hora").innerText = new Date().toLocaleTimeString('es-PE');
          enviar(latitude, longitude, accuracy, speed);
        },
        err => {
          statusEl.innerHTML = "‚ùå Error al obtener GPS: " + err.message;
        },
        { enableHighAccuracy: true, maximumAge: 5000, timeout: 10000 }
      );
    }
  </script>
</body>
</html>
