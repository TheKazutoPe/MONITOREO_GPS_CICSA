<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CICSA Monitoreo GPS</title>
  <style>
    body {
      font-family: "Segoe UI", sans-serif;
      background: radial-gradient(circle at center, #001a2b, #000c14);
      color: #fff;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      margin: 0;
    }

    .card {
      background: rgba(10, 30, 50, 0.92);
      border-radius: 14px;
      padding: 25px;
      width: 350px;
      text-align: center;
      box-shadow: 0 0 20px rgba(0, 255, 200, 0.4);
      transition: all 0.3s;
    }

    .card.glow {
      box-shadow: 0 0 25px rgba(0, 255, 200, 0.8);
    }

    .logo {
      display: block;
      margin: 0 auto 15px;
      height: 60px;
    }

    h2 {
      margin: 8px 0;
      color: #fff;
    }

    input {
      width: 90%;
      padding: 8px;
      margin: 6px 0;
      border: none;
      border-radius: 6px;
      text-align: center;
    }

    button {
      background: #00b050;
      color: #fff;
      border: none;
      border-radius: 6px;
      padding: 10px 15px;
      cursor: pointer;
      margin-top: 8px;
      width: 95%;
      font-weight: 600;
    }

    button:hover { background: #009944; }

    #status {
      margin-top: 12px;
      font-size: 14px;
      color: #00e676;
    }

    #info {
      background: rgba(0, 0, 0, 0.25);
      border-radius: 8px;
      margin-top: 10px;
      text-align: left;
      padding: 8px 12px;
      font-size: 13px;
      display: none;
    }
  </style>
</head>
<body>
  <div class="card" id="panel">
    <img src="/static/logo_cicsa.png" alt="CICSA" class="logo" />
    <h2>Monitoreo GPS - T√©cnico</h2>
    <p>Inicio de sesi√≥n</p>

    <input id="usuario" placeholder="Nombre del t√©cnico" />
    <input id="brigada" placeholder="Brigada" />
    <input id="contrata" placeholder="Contrata" />
    <input id="zona" placeholder="Zona (NORTE, SUR...)" />
    <select id="cargo">
      <option value="T√©cnico">T√©cnico</option>
      <option value="Supervisor">Supervisor</option>
      <option value="Monitoreo">Monitoreo</option>
    </select>

    <button id="btnStart">Iniciar transmisi√≥n</button>
    <div id="status"></div>
    <div id="info"></div>
  </div>

  <script>
    const btn = document.getElementById("btnStart");
    const statusEl = document.getElementById("status");
    const infoEl = document.getElementById("info");
    const panel = document.getElementById("panel");

    let lastSend = 0;

    async function enviarPosicion(data) {
      try {
        const res = await fetch("/api/posicion", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(data)
        });
        const out = await res.json();
        if (!out.ok) console.error("‚ö†Ô∏è Error del servidor:", out.error);
      } catch (err) {
        console.error("‚ùå Error al enviar posici√≥n:", err);
      }
    }

    function iniciar() {
      const tecnico = document.getElementById("usuario").value.trim();
      const brigada = document.getElementById("brigada").value.trim() || "N/A";
      const contrata = document.getElementById("contrata").value.trim() || "N/A";
      const zona = document.getElementById("zona").value.trim() || "N/A";
      const cargo = document.getElementById("cargo").value;
      const usuario_id = Math.floor(Math.random() * 1000000); // ID temporal

      if (!tecnico) {
        alert("Ingrese su nombre o usuario.");
        return;
      }

      btn.disabled = true;
      btn.textContent = "Transmitiendo...";
      panel.classList.add("glow");
      infoEl.style.display = "block";
      statusEl.textContent = "üü¢ Transmitiendo posici√≥n GPS...";

      if (!navigator.geolocation) {
        statusEl.textContent = "‚ö†Ô∏è Geolocalizaci√≥n no soportada.";
        return;
      }

      navigator.geolocation.watchPosition(
        async (pos) => {
          const { latitude, longitude, accuracy, speed } = pos.coords;
          const ahora = Date.now();
          if (ahora - lastSend < 5000) return; // cada 5 s
          lastSend = ahora;

          infoEl.innerHTML = `
            <b>Coordenadas:</b> ${latitude.toFixed(5)}, ${longitude.toFixed(5)}<br>
            <b>Precisi√≥n:</b> ${accuracy.toFixed(1)} m<br>
            <b>Velocidad:</b> ${(speed || 0).toFixed(1)} km/h<br>
            <b>Hora:</b> ${new Date().toLocaleTimeString()}
          `;

          const payload = {
            usuario_id,
            tecnico,
            brigada,
            contrata,
            zona,
            cargo,
            lat: latitude,
            lng: longitude
          };

          await enviarPosicion(payload);
        },
        (err) => {
          console.error("Error GPS:", err);
          statusEl.textContent = "‚ö†Ô∏è Error obteniendo posici√≥n.";
        },
        { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
      );
    }

    btn.onclick = iniciar;
  </script>
</body>
</html>
