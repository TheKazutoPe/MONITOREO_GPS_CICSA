<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Login Brigadas</title>
<style>
  body{font-family:system-ui,Arial,sans-serif;padding:16px;max-width:520px;margin:auto}
  .card{border:1px solid #e9ecef;border-radius:14px;padding:16px;box-shadow:0 8px 20px rgba(0,0,0,.05)}
  label{display:block;margin:.5rem 0 .2rem}
  input,select,button{width:100%;padding:.75rem;border:1px solid #ced4da;border-radius:10px}
  button{cursor:pointer;margin-top:.75rem}
  .row{display:grid;grid-template-columns:1fr 1fr;gap:.5rem}
  .muted{color:#6c757d;font-size:.9rem}
</style>
</head>
<body>
  <h2>Monitoreo de Brigadas</h2>
  <p class="muted">Inicia sesión con tu usuario y clave registrados en Supabase.</p>

  <div class="card">
    <label>Usuario</label>
    <input id="usuario" placeholder="usuario" />
    <label>Clave</label>
    <input id="clave" type="password" placeholder="•••••••" />
    <button id="btnLogin">Ingresar</button>
  </div>

  <div id="panel" class="card" style="display:none;">
    <div id="bienvenida" class="muted"></div>
    <div class="row">
      <button id="btnIniciar">Iniciar recorrido</button>
      <button id="btnDetener" disabled>Detener</button>
    </div>
    <p class="muted" id="estado">GPS: inactivo</p>
  </div>

<script>
let user=null, timer=null;

document.getElementById('btnLogin').onclick = async ()=>{
  const res = await fetch('/api/login',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body: JSON.stringify({
      usuario: usuario.value.trim(),
      clave: clave.value.trim()
    })
  });
  const r = await res.json();
  if(!r.ok){ alert('Usuario o clave inválidos'); return; }

  user = r.usuario;
  document.querySelector('.card').style.display='none';
  panel.style.display='block';
  bienvenida.textContent = `Bienvenido ${user.nombre} (${user.cargo}) — ${user.brigada || ''} ${user.zona || ''} ${user.contrata || ''}`;
};

document.getElementById('btnIniciar').onclick = ()=>{
  if (!navigator.geolocation) { alert('Tu dispositivo no soporta GPS'); return; }
  btnIniciar.disabled=true; btnDetener.disabled=false;
  estado.textContent = 'GPS: transmitiendo cada 15s…';

  const send = (pos)=>{
    fetch('/api/posicion',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({
        usuario_id: user.id,
        tecnico: user.nombre,
        brigada: user.brigada,
        contrata: user.contrata,
        zona: user.zona,
        cargo: user.cargo,
        lat: pos.coords.latitude,
        lng: pos.coords.longitude,
        acc: pos.coords.accuracy,
        spd: pos.coords.speed
      })
    });
  };

  navigator.geolocation.getCurrentPosition(send);
  timer = setInterval(()=> navigator.geolocation.getCurrentPosition(send), 15000);
};

document.getElementById('btnDetener').onclick = ()=>{
  clearInterval(timer);
  btnIniciar.disabled=false; btnDetener.disabled=true;
  estado.textContent = 'GPS: detenido';
};
</script>
</body>
</html>
