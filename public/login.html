<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Monitoreo GPS CICSA</title>

<style>
  :root{
    --bg:#07131c;
    --card:#0f2536;
    --card-2:#0c1e2b;
    --brand:#14cba8;
    --brand-dk:#0ea789;
    --text:#eaf6ff;
    --muted:#b7d3e8;
    --danger:#d94156;
    --shadow:0 20px 50px rgba(0,0,0,.35), 0 0 40px rgba(20,203,168,.12);
    --radius:16px;
  }
  html,body{height:100%}
  body{
    margin:0;
    background:
      radial-gradient(1200px 800px at 12% 8%, rgba(20,203,168,.12), transparent 60%),
      radial-gradient(1200px 800px at 88% 92%, rgba(13,148,136,.10), transparent 60%),
      var(--bg);
    color:var(--text);
    font:15px/1.45 "Segoe UI", system-ui, -apple-system, Roboto, Arial;
    display:grid; place-items:center;
  }
  .card{
    width:min(420px, 92vw);
    background:linear-gradient(180deg, var(--card), var(--card-2));
    border:1px solid #16384c;
    border-radius:var(--radius);
    padding:28px 24px;
    box-shadow:var(--shadow);
    position:relative;
  }
  .card.glow::after{
    content:""; position:absolute; inset:-8px;
    border-radius: calc(var(--radius) + 8px);
    box-shadow: 0 0 60px rgba(20,203,168,.35);
    pointer-events:none;
  }
  .logo{height:48px; display:block; margin:2px auto 8px;}
  h1{ font-size:24px; text-align:center; margin:10px 0 6px; letter-spacing:.2px; }
  small.sub{ display:block; text-align:center; color:var(--muted); margin-bottom:14px; }

  .field{ display:flex; gap:10px; margin:6px 0 8px; }
  .input{
    flex:1; border:1px solid #17354a; background:#0a1d2a; color:var(--text);
    border-radius:12px; padding:12px 12px; outline:none; font-weight:600; text-align:center;
  }
  .row{ display:flex; gap:10px; margin:6px 0 10px; }
  .btn{
    flex:1; border:none; border-radius:12px; padding:12px 14px;
    font-weight:800; letter-spacing:.2px; cursor:pointer;
    box-shadow: inset 0 -2px 0 rgba(0,0,0,.25);
    transition: transform .06s ease-in-out, opacity .2s, background .2s;
  }
  .btn:active{ transform: translateY(1px); }
  .primary{ background:var(--brand); color:#03211c; }
  .primary:hover{ background:var(--brand-dk); }
  .primary:disabled{ opacity:.65; }
  .danger{ background:var(--danger); color:#fff; }

  .info{
    display:none; margin-top:8px; text-align:left; background:rgba(0,0,0,.25);
    padding:12px; border-radius:12px; color:#bfe9ff; font-size:13px;
  }
  .info b{ color:#dff3ff }
  .info hr{ border:0; border-top:1px solid rgba(255,255,255,.08); margin:8px 0; }
  .error{ color:#ffb3c1; min-height:18px; text-align:center; margin-top:4px; }
  #status{ margin-top:10px; font-size:13px; color:#bde5ff; text-align:center }
</style>
</head>
<body>
  <div class="card" id="panel">
    <img src="/static/logo_cicsa.png" alt="CICSA" class="logo" />
    <h1>Monitoreo GPS</h1>
    <small class="sub">CICSA ‚Ä¢ Tiempo real</small>

    <div class="field">
      <input id="usuario" class="input" placeholder="Usuario" autocomplete="username">
    </div>
    <div class="field">
      <input id="clave" class="input" type="password" placeholder="Clave" autocomplete="current-password">
    </div>

    <div class="row">
      <button id="btnStart" class="btn primary">Iniciar transmisi√≥n</button>
      <button id="btnStop" class="btn danger" disabled>Detener</button>
    </div>

    <div class="info" id="info"></div>
    <div class="error" id="error"></div>
    <div id="status"></div>
  </div>

<script>
const API = location.origin;

const panel   = document.getElementById('panel');
const btnStart= document.getElementById('btnStart');
const btnStop = document.getElementById('btnStop');
const infoEl  = document.getElementById('info');
const errorEl = document.getElementById('error');
const statusEl= document.getElementById('status');

let user = null;
let watchId = null;
let lastSend = 0;
let lastWeakSend = 0;

// UMBRALES internos
const ACC_TARGET = 50;
const ACC_MAX    = 150;
const MIN_INTERVAL_MS       = 4500;
const MIN_INTERVAL_WEAK_MS  = 20000;

async function login(usuario, clave){
  const res = await fetch(`${API}/api/login`,{
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify({usuario, clave})
  });
  const data = await res.json();
  if(!data.ok) throw new Error(data.error || "Login inv√°lido");
  return data.usuario; // nombre, brigada, etc.
}

async function enviarPosicion(data){
  await fetch(`${API}/api/posicion`,{
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify(data)
  });
}

// ‚¨áÔ∏è NUEVO: stop robusto: fetch + sendBeacon
async function sendStop(payload){
  try{
    await fetch(`${API}/api/stop`,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify(payload),
      keepalive: true
    });
  }catch(_e){}
  try{
    const blob = new Blob([JSON.stringify(payload)], { type: "application/json" });
    navigator.sendBeacon(`${API}/api/stop`, blob);
  }catch(_e){}
}

function warmupGPS(){
  if (!navigator.geolocation) return;
  navigator.geolocation.getCurrentPosition(
    ()=>{}, ()=>{},
    { enableHighAccuracy:true, maximumAge:0, timeout:20000 }
  );
}

function iniciarGPS(usr){
  user = usr;
  panel.classList.add("glow");
  btnStart.disabled = true;
  btnStop.disabled  = false;
  btnStart.textContent = "Transmitiendo...";
  statusEl.textContent = "üü¢ Transmitiendo posici√≥n en tiempo real...";
  infoEl.style.display = "block";
  errorEl.textContent = "";

  if (!navigator.geolocation){
    errorEl.textContent = "Geolocalizaci√≥n no soportada en este navegador.";
    return;
  }

  warmupGPS();

  const opts = { enableHighAccuracy:true, maximumAge:0, timeout:30000 };
  watchId = navigator.geolocation.watchPosition(async (pos)=>{
    const crd = pos.coords;
    const now = Date.now();
    const acc = Number(crd.accuracy);

    infoEl.innerHTML = `
      <b>Coordenadas:</b> ${crd.latitude.toFixed(5)}, ${crd.longitude.toFixed(5)}<br>
      <b>Hora (Lima):</b> ${new Date().toLocaleTimeString("es-PE",{timeZone:"America/Lima"})}<br>
      <hr>
      <b>Nombre:</b> ${user.nombre || '‚Äî'}<br>
      <b>Brigada:</b> ${user.brigada || '‚Äî'}<br>
      <b>Contrata:</b> ${user.contrata || '‚Äî'}<br>
      <b>Zona:</b> ${user.zona || '‚Äî'}<br>
      <b>Cargo:</b> ${user.cargo || '‚Äî'}<br>
      <b>Tel√©fono:</b> ${user.telefono || '‚Äî'}
    `;

    if (isFinite(acc) && acc > ACC_MAX) {
      statusEl.textContent = "üì° Optimizando se√±al‚Ä¶";
      warmupGPS();
      return;
    }

    if (isFinite(acc) && acc > ACC_TARGET && acc <= ACC_MAX) {
      statusEl.textContent = "üì° Se√±al inestable, enviando menos frecuente‚Ä¶";
      if (now - lastWeakSend < MIN_INTERVAL_WEAK_MS) return;
      lastWeakSend = now;
    } else {
      if (now - lastSend < MIN_INTERVAL_MS) return;
      lastSend = now;
    }

    const payload = {
      usuario_id: user.id,
      tecnico: user.nombre,
      brigada: user.brigada,
      contrata: user.contrata,
      zona: user.zona,
      cargo: user.cargo,
      lat: crd.latitude,
      lng: crd.longitude
    };
    try{
      await enviarPosicion(payload);
      statusEl.textContent = "üü¢ Enviado";
    }catch(e){
      console.error(e);
      errorEl.textContent = "No se pudo enviar posici√≥n.";
    }
  }, (err)=>{
    errorEl.textContent = "No se puede obtener tu ubicaci√≥n (" + err.message + ")";
  }, opts);
}

function detenerGPSUI(){
  panel.classList.remove("glow");
  btnStart.disabled = false;
  btnStop.disabled  = true;
  btnStart.textContent = "Iniciar transmisi√≥n";
  statusEl.textContent = "‚èπÔ∏è Transmisi√≥n detenida.";
  infoEl.style.display = "none";
}

btnStart.onclick = async ()=>{
  const u = document.getElementById('usuario').value.trim();
  const p = document.getElementById('clave').value.trim();
  if (!u || !p) { errorEl.textContent = "Ingrese usuario y clave"; return; }
  try{
    const usr = await login(u, p);
    iniciarGPS(usr);
  }catch(e){
    errorEl.textContent = e.message;
  }
};

btnStop.onclick = async ()=>{
  if (watchId != null){
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
  }
  // ‚¨áÔ∏è NUEVO: payload compatible (id + brigada) y env√≠o doble (fetch + beacon)
  const stopPayload = {
    usuario_id: user?.id ?? null,
    brigada: user?.brigada ?? null
  };
  await sendStop(stopPayload);
  detenerGPSUI();
};
</script>
</body>
</html>
