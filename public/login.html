<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Monitoreo GPS CICSA</title>
<style>
  body {
    background: radial-gradient(circle at center, #001a2b, #000c14);
    color: #fff;
    height: 100vh; display:flex; justify-content:center; align-items:center;
    font-family: "Segoe UI", sans-serif;
  }
  .card{background:rgba(10,30,50,.92);border-radius:14px;padding:25px;width:350px;text-align:center;
        box-shadow:0 0 20px rgba(0,255,200,.4);transition:.3s;}
  .card.glow{box-shadow:0 0 25px rgba(0,255,200,.8)}
  .logo{height:60px;margin-bottom:10px;}
  input{
    width: 90%; padding: 10px 12px; border-radius:10px; border:1px solid #0a2a3f;
    background:#06121c; color:#dff1ff; outline:none; text-align:center; margin:6px 0;
  }
  .row{display:flex; gap:8px; margin:8px 0;}
  button{
    background:#0aa6a6; border:none; color:#002b36; padding:10px 12px; border-radius:10px; cursor:pointer; font-weight:600; width:100%;
  }
  button:disabled{ opacity:.6; }
  .danger{ background:#da3d5b; color:#fff; }
  .info{ font-size:13px; color:#bfe9ff; display:none; margin-top:8px; text-align:left; background:rgba(0,0,0,.25); padding:8px 12px; border-radius:8px; }
  .error{ color:#ffb3c1; min-height:18px; margin-top:6px; }
  #status{ margin-top:8px;font-size:13px;color:#bde5ff }
</style>
</head>
<body>
  <div class="card" id="panel">
    <img src="/static/logo_cicsa.png" alt="CICSA" class="logo" />
    <h2>Monitoreo GPS</h2>
    <small>CICSA ‚Ä¢ Tiempo real</small>

    <input id="usuario" placeholder="Usuario" />
    <input id="clave" placeholder="Clave" type="password" />
    <div class="row">
      <button id="btnStart">Iniciar transmisi√≥n</button>
      <button id="btnStop" class="danger" disabled>Detener</button>
    </div>
    <div class="info" id="info"></div>
    <div class="error" id="error"></div>
    <div id="status"></div>
  </div>

<script>
const API = location.origin;

const panel   = document.getElementById('panel');
const btnStart= document.getElementById('btnStart');
const btnStop = document.getElementById('btnStop');
const infoEl  = document.getElementById('info');
const errorEl = document.getElementById('error');
const statusEl= document.getElementById('status');

let user = null;
let watchId = null;
let lastSend = 0;
let lastWeakSend = 0; // env√≠os con precisi√≥n intermedia

// UMBRALES DE PRECISI√ìN (en metros)
const ACC_TARGET = 50;   // ideal
const ACC_MAX    = 150;  // por encima de esto NO se env√≠a
const MIN_INTERVAL_MS       = 4500;  // intervalo normal (precisi√≥n buena)
const MIN_INTERVAL_WEAK_MS  = 20000; // intervalo cuando precisi√≥n es 50..150

async function login(usuario, clave){
  const res = await fetch(`${API}/api/login`,{
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify({usuario, clave})
  });
  const data = await res.json();
  if(!data.ok) throw new Error(data.error || "Login inv√°lido");
  return data.usuario;
}

async function enviarPosicion(data){
  await fetch(`${API}/api/posicion`,{
    method:"POST", headers:{"Content-Type":"application/json"},
    body: JSON.stringify(data)
  });
}

// Dispara un getCurrentPosition para ‚Äúforzar‚Äù un fix GPS m√°s preciso
function warmupGPS(){
  if (!navigator.geolocation) return;
  navigator.geolocation.getCurrentPosition(
    ()=>{}, ()=>{},
    { enableHighAccuracy:true, maximumAge:0, timeout:20000 }
  );
}

function iniciarGPS(usr){
  user = usr;
  panel.classList.add("glow");
  btnStart.disabled = true;
  btnStop.disabled  = false;
  btnStart.textContent = "Transmitiendo...";
  statusEl.textContent = "üü¢ Transmitiendo posici√≥n en tiempo real...";
  infoEl.style.display = "block";
  errorEl.textContent = "";

  if (!navigator.geolocation){
    errorEl.textContent = "Geolocalizaci√≥n no soportada en este navegador.";
    return;
  }

  // Warm-up: intenta fijar GPS antes del watch
  warmupGPS();

  const opts = { enableHighAccuracy:true, maximumAge:0, timeout:30000 };
  watchId = navigator.geolocation.watchPosition(async (pos)=>{
    const crd = pos.coords;
    const now = Date.now();
    const acc = Number(crd.accuracy);

    // Mostrar en UI siempre
    infoEl.innerHTML = `
      <b>Coordenadas:</b> ${crd.latitude.toFixed(5)}, ${crd.longitude.toFixed(5)}<br>
      <b>Precisi√≥n:</b> ${isFinite(acc) ? acc.toFixed(1) : '‚Äî'} m<br>
      <b>Hora (Lima):</b> ${new Date().toLocaleTimeString("es-PE",{timeZone:"America/Lima"})}
    `;

    // 1) Si la precisi√≥n es muy mala, NO enviar y pedir un fix mejor en paralelo.
    if (isFinite(acc) && acc > ACC_MAX) {
      statusEl.textContent = "üì° Mejorando precisi√≥n (evitando env√≠os > 150 m)‚Ä¶";
      warmupGPS(); // pide un fix m√°s preciso sin bloquear
      return;
    }

    // 2) Precisi√≥n intermedia (50..150 m): enviar solo cada 20s
    if (isFinite(acc) && acc > ACC_TARGET && acc <= ACC_MAX) {
      statusEl.textContent = "üì° Precisi√≥n intermedia, enviando menos frecuente‚Ä¶";
      if (now - lastWeakSend < MIN_INTERVAL_WEAK_MS) return;
      lastWeakSend = now;
      // cae a enviar abajo (sin interferir con el intervalo normal)
    } else {
      // Precisi√≥n buena: respeta intervalo normal
      if (now - lastSend < MIN_INTERVAL_MS) return;
      lastSend = now;
    }

    const payload = {
      usuario_id: user.id,
      tecnico: user.tecnico,
      brigada: user.brigada,
      contrata: user.contrata,
      zona: user.zona,
      cargo: user.cargo,
      lat: crd.latitude,
      lng: crd.longitude
    };
    try{
      await enviarPosicion(payload);
      statusEl.textContent = "üü¢ Enviado";
    }catch(e){
      console.error(e);
      errorEl.textContent = "No se pudo enviar posici√≥n.";
    }
  }, (err)=>{
    errorEl.textContent = "No se puede obtener tu ubicaci√≥n (" + err.message + ")";
  }, opts);
}

function detenerGPSUI(){
  panel.classList.remove("glow");
  btnStart.disabled = false;
  btnStop.disabled  = true;
  btnStart.textContent = "Iniciar transmisi√≥n";
  statusEl.textContent = "‚èπÔ∏è Transmisi√≥n detenida.";
  infoEl.style.display = "none";
}

btnStart.onclick = async ()=>{
  const u = document.getElementById('usuario').value.trim();
  const p = document.getElementById('clave').value.trim();
  if (!u || !p) { errorEl.textContent = "Ingrese usuario y clave"; return; }
  try{
    const usr = await login(u, p);
    iniciarGPS(usr);
  }catch(e){
    errorEl.textContent = e.message;
  }
};

btnStop.onclick = async ()=>{
  if (watchId != null){
    navigator.geolocation.clearWatch(watchId);
    watchId = null;
  }
  try{
    if (user?.id) {
      await fetch(`${API}/api/stop`,{
        method:"POST", headers:{"Content-Type":"application/json"},
        body: JSON.stringify({ usuario_id: user.id })
      });
    }
  }catch(_e){}
  detenerGPSUI();
};
</script>
</body>
</html>

